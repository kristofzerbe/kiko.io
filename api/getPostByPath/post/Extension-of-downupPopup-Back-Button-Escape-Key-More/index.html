{"type":"getPostByPath","data":{"title":"Extension of downupPopup: Back Button, Escape Key & More","date":"2023-07-04T11:07:38.000Z","description":"<p>I recently introduced a Bottom Sheet dialog on this blog to display a page’s metadata (<a href=\"javascript:dialog.pageMeta()\">like this</a>), using Ali Dincer’s work: <a href=\"https://downuppopupjs.dincerali.com/\"><strong>downupPopup</strong></a>. I described the way to do this in <a href=\"/post/Show-pages-meta-data-JSON-LD-in-Bottom-Sheet/\">a post</a> a couple three weeks ago.</p>\n<p>Shortly after that <a href=\"https://octodon.social/@koos\">Koos Looijensteijn</a> triggered me with his post <a href=\"https://www.kooslooijesteijn.net/blog/digital-business-cards-vcard-qr-code-website\">How to make digital business cards and share them via QR codes</a> and I felt like using my newly introduced dialog manager based on downupPopup for my own contact card.<br><strong>But more about that at a later time, respectively blog post…</strong></p>\n<p>Important for this post is that Ali’s bottom sheet solution did not offer everything I wanted for my implementation:</p>\n<h2 id=\"1-Make-Dialog-Reusable\"><a href=\"#1-Make-Dialog-Reusable\" class=\"headerlink\" title=\"1. Make Dialog Reusable\"></a>1. Make Dialog Reusable</h2><p>As I have already described in the above mentioned article: Ali’s approach to calling the dialog was to create and initialize the necessary HTML elements if it didn’t already exist in the DOM. I pulled out the initialization to make the component reusable. There is now a preparation part and an initialization part and the latter is always called, no matter if another bottom sheet dialog was already created before.</p>\n<p><a href=\"https://github.com/ali-dincer/downupPopup.js/pull/2/commits/f3751ca56c4809decc1ec3845e5c301a13292773\">My GitHub commit on this part</a>…</p>","categories":[{"name":"UI/UX","_id":"clm1uxfnk003fk3ol67qfg4ak"}],"tags":[{"name":"UI","_id":"clm1uxfo6003gk3olfkgu81ty"},{"name":"GitHub","_id":"clm1uxfoc003sk3olhuxn0pin"},{"name":"jQuery","_id":"clm1uxfoh0042k3olclco0oz3"},{"name":"Contributing","_id":"clm1uxfsq00d5k3ol5sqi5hs1"}],"content":"<p>I recently introduced a Bottom Sheet dialog on this blog to display a page’s metadata (<a href=\"javascript:dialog.pageMeta()\">like this</a>), using Ali Dincer’s work: <a href=\"https://downuppopupjs.dincerali.com/\"><strong>downupPopup</strong></a>. I described the way to do this in <a href=\"/post/Show-pages-meta-data-JSON-LD-in-Bottom-Sheet/\">a post</a> a couple three weeks ago.</p>\n<p>Shortly after that <a href=\"https://octodon.social/@koos\">Koos Looijensteijn</a> triggered me with his post <a href=\"https://www.kooslooijesteijn.net/blog/digital-business-cards-vcard-qr-code-website\">How to make digital business cards and share them via QR codes</a> and I felt like using my newly introduced dialog manager based on downupPopup for my own contact card.<br><strong>But more about that at a later time, respectively blog post…</strong></p>\n<p>Important for this post is that Ali’s bottom sheet solution did not offer everything I wanted for my implementation:</p>\n<h2 id=\"1-Make-Dialog-Reusable\"><a href=\"#1-Make-Dialog-Reusable\" class=\"headerlink\" title=\"1. Make Dialog Reusable\"></a>1. Make Dialog Reusable</h2><p>As I have already described in the above mentioned article: Ali’s approach to calling the dialog was to create and initialize the necessary HTML elements if it didn’t already exist in the DOM. I pulled out the initialization to make the component reusable. There is now a preparation part and an initialization part and the latter is always called, no matter if another bottom sheet dialog was already created before.</p>\n<p><a href=\"https://github.com/ali-dincer/downupPopup.js/pull/2/commits/f3751ca56c4809decc1ec3845e5c301a13292773\">My GitHub commit on this part</a>…</p>\n<span id=\"more\"></span>\n\n<hr>\n<h2 id=\"2-Dynamic-Distance\"><a href=\"#2-Dynamic-Distance\" class=\"headerlink\" title=\"2. Dynamic Distance\"></a>2. Dynamic Distance</h2><p>Since it makes no sense to have to scroll around on a contact card if the space provided by the web designer is not sufficient at small resolutions, I need a more dynamic approach to Ali’s <em><code>distance</code></em>, which sets the distance of the bottom sheet to the top of the viewport. </p>\n<p>To do this, I introduced a new setting called <strong><code>minContentHeight</code></strong> that can specify in pixels how high the content must be at least for everything to be visible. Because this makes the possibly specified <code>distance</code> absurd,  I overwrite this specification with a value calculated with it and only then enter the distance value into the element attribute for further use. </p>\n<p>For the calculation to be correct, however, I need a fixed value for the HEADER of the dialog at this point, which was previously only defined in the CSS. In retrospect, this was a good decision, because once slight pixel shifts between HEADER and CONTENT disappeared in Google’s Chrome, my preferred browser.</p>\n<figure class=\"highlight js\"><figcaption><span>downupPopup.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Option Handling</span></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> settings = $.<span class=\"title function_\">extend</span>(&#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"attr\">minContentHeight</span>: <span class=\"literal\">null</span>,</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Initialization</span></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// setting header height</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> $head = $this.<span class=\"title function_\">find</span>(<span class=\"string\">&quot;.downupPopup-header&quot;</span>);</span><br><span class=\"line\">$head.<span class=\"title function_\">find</span>(<span class=\"string\">&quot;span&quot;</span>).<span class=\"title function_\">text</span>(settings.<span class=\"property\">headerText</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> headH = <span class=\"number\">6</span>;</span><br><span class=\"line\">$head.<span class=\"title function_\">css</span>(<span class=\"string\">&#x27;height&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span> + headH + <span class=\"string\">&#x27;vh&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// calculating dynamic distance by given minContentHeight</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (settings.<span class=\"property\">minContentHeight</span>) &#123; </span><br><span class=\"line\">  <span class=\"keyword\">let</span> calcDistance = <span class=\"title class_\">Math</span>.<span class=\"title function_\">round</span>((<span class=\"number\">100</span> * (<span class=\"variable language_\">window</span>.<span class=\"property\">innerHeight</span> - settings.<span class=\"property\">minContentHeight</span>) / <span class=\"variable language_\">window</span>.<span class=\"property\">innerHeight</span>)) - headH;</span><br><span class=\"line\">  settings.<span class=\"property\">distance</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">max</span>(<span class=\"number\">0</span>, calcDistance);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$this.<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;distance&#x27;</span>, settings.<span class=\"property\">distance</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// setting distance to top</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> $cont = $this.<span class=\"title function_\">find</span>(<span class=\"string\">&quot;.downupPopup-content&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> contH = <span class=\"number\">100</span> - settings.<span class=\"property\">distance</span> - headH;</span><br><span class=\"line\">$cont.<span class=\"title function_\">css</span>(<span class=\"string\">&#x27;height&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span> + contH + <span class=\"string\">&#x27;vh&#x27;</span>);</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://github.com/ali-dincer/downupPopup.js/pull/2/commits/0b1b72a4dd5ceb4b1436540a44c24f256f92a1ad\">My GitHub commit on this part</a>…</p>\n<hr>\n<h2 id=\"3-Closing-Dialog-by-ESC-Key-or-BACK-Button\"><a href=\"#3-Closing-Dialog-by-ESC-Key-or-BACK-Button\" class=\"headerlink\" title=\"3. Closing Dialog by ESC Key or BACK Button\"></a>3. Closing Dialog by ESC Key or BACK Button</h2><p>With Koos’ really nice <a href=\"https://www.fortomorrow.eu/en/contact/koos\">contact card</a>, I noticed that I automatically tried to close his SHARE DATA popup dialog with the QRCode, which is created on-the-fly with JavaScript, with the BACK button, but ended up on a completely different, previously called page. I guess this is a psychological thing: if an element not bound to the url overlaps the current page, people (or just me?) perceives it as an independent page and try to navigate with long learned methods.</p>\n<p>So what was missing was, on the one hand, the ability to close the dialog using the <strong>ESCAPE key</strong> (for desktop users) and, on the other hand, to manipulate the URL history so that the <strong>BACK button</strong> or the corresponding mobile gesture works as expected.</p>\n<p>For the latter I needed again a new setting: the hash which will be added to the current URL to make the BACK button work: <code>urlHash</code>. </p>\n<p>In addition, there were several redundant places in the original code, with which the dialog was closed, which I have summarized in a function, in order to avoid the new necessary to write several times. (<a href=\"https://github.com/ali-dincer/downupPopup.js/pull/2/commits/fa0e119b42a444f1cb671d02381029f662d94591\">my GitHub commit on this part</a>).</p>\n<figure class=\"highlight js\"><figcaption><span>downupPopup.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Option Handling</span></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> settings = $.<span class=\"title function_\">extend</span>(&#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"attr\">urlHash</span>: <span class=\"literal\">null</span>,</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// General CLOSE function</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">close</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// unbind ESC</span></span><br><span class=\"line\">  $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">off</span>(<span class=\"string\">&#x27;keyup&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// remove url hash &amp; unbind BACK button</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (settings?.<span class=\"property\">urlHash</span> || $this.<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;hash&#x27;</span>)) &#123;</span><br><span class=\"line\">    history.<span class=\"title function_\">replaceState</span>(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>, <span class=\"string\">&#x27; &#x27;</span>);</span><br><span class=\"line\">    $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">off</span>(<span class=\"string\">&quot;popstate&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Initialization</span></span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// bind ESC to close</span></span><br><span class=\"line\">$(<span class=\"variable language_\">document</span>).<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;keyup&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(event.<span class=\"property\">key</span> == <span class=\"string\">&quot;Escape&quot;</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">close</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (settings.<span class=\"property\">urlHash</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// set url hash &amp; bind BACK button to close</span></span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"property\">location</span>.<span class=\"property\">hash</span> = settings.<span class=\"property\">urlHash</span>;</span><br><span class=\"line\">  $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">on</span>(<span class=\"string\">&quot;popstate&quot;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_\">close</span>();</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$this.<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;hash&#x27;</span>, settings.<span class=\"property\">urlHash</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>The key of this code regarding the BACK button is to put the passed hash into the URL when initializing the dialog via <code>window.location.hash</code> and to make sure that it is closed when the hash is removed again by the BACK button. I achieved this by using the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/popstate_event\"><code>popstate</code></a> event, which fires when the active history entry changes.</p>\n<p>When the dialog is about to close, I had to make sure that the <code>history</code> entry is overwritten via <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/History/replaceState\"><code>replaceState</code></a> with <code>null</code> (delete) and remove the previously bound <code>popstate</code> event again, to avoid side effects.</p>\n<p>The code for the ESC key is similar: Bind the <code>keyup</code> event on startup to close the dialog and remove it again on close.</p>\n<p><a href=\"https://github.com/ali-dincer/downupPopup.js/pull/2/commits/1577a0e6306f75101afb09dc05f7abf80dc29e40\">My GitHub commit on this part</a>…</p>\n<hr>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>Everything works as expected and I hope that Ali will process my pull request soon. Until then you can find the code <a href=\"https://github.com/kristofzerbe/downupPopup.js\">in my fork</a>.</p>\n<p>All in all, the script has not become more readable or easier to maintain, even by using jQuery. In my head I already have the idea to do a complete rewrite as ESM class. Reason for this is surely Ali’s approach to realize commands like ‘open’ and ‘close’ as string parameters. This works better than real functions of an instantiated object. Furthermore, it is necessary to cache settings like <code>distance</code> and <code>urlHash</code> in HTML attributes, which does not have to be this way.</p>\n","_path":"post/Extension-of-downupPopup-Back-Button-Escape-Key-More/","_link":"https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/","_id":"clm1uxfms0032k3ol2vhbhmzb"}}