{"type":"getPostByPath","data":{"title":"Custom Caller Authentication with ASP.NET Core 5.0 Web API","date":"2021-02-28T16:05:00.000Z","description":"<p>Developing micro services with Microsoft ASP.NET Core 5.0 Web API is powerful and fun, but the fun stops, if your data are accesses unauthorized. It is absolutely fundamental to have a protection layer, which filters out unwanted data requests.  </p>\n<p>A common way is to limit the service access by providing API Keys to well known clients. In this post I will show you how to implement such a filter in terms of API keys and IP addresses. </p>","categories":[{"name":".NET","_id":"clo41jfqv0057p0oucazj5ar4"}],"tags":[{"name":"Visual Studio","_id":"clo41jfqv0056p0ougja00nbd"},{"name":"WebAPI","_id":"clo41jfsd008pp0ou0woc4i9c"},{"name":"Authentication","_id":"clo41jfse008rp0ou5oxoh5nj"}],"content":"<p>Developing micro services with Microsoft ASP.NET Core 5.0 Web API is powerful and fun, but the fun stops, if your data are accesses unauthorized. It is absolutely fundamental to have a protection layer, which filters out unwanted data requests.  </p>\n<p>A common way is to limit the service access by providing API Keys to well known clients. In this post I will show you how to implement such a filter in terms of API keys and IP addresses. </p>\n<span id=\"more\"></span>\n\n<h2 id=\"The-Settings\"><a href=\"#The-Settings\" class=\"headerlink\" title=\"The Settings\"></a>The Settings</h2><p>Lets start with the list of clients, who should be able to access the data. The most useful place for this is in the <strong>appsettings.json</strong> of the Core 5.0 Web API project:</p>\n<figure class=\"highlight json\"><figcaption><span>appsettings.json</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">&quot;Callers&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;localhost&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;ApiKey&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">null</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;IPAddress&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;::1&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;Name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;John Doe&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;ApiKey&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;mytopsecretapikeyforjohndoe&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;IPAddress&quot;</span><span class=\"punctuation\">:</span>  <span class=\"string\">&quot;*&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>This list has two entries: one for the server itself (“localhost”), which is restricted to the local IP address <code>&quot;::1&quot;</code>, and one for the test user <code>&quot;John Doe&quot;</code>, who can access from any IP address (<code>&quot;*&quot;</code>), but must supply his personal API key with his requests.</p>\n<p>In order to handle this setting, we have to introduce it to the system at startup as a class:</p>\n<figure class=\"highlight c#\"><figcaption><span>CallerSetting.cs</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CallerSetting</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> Name &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> ApiKey &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">string</span> IPAddress &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight c#\"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span> </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  IConfigurationSection configSection = Configuration.GetSection(<span class=\"string\">&quot;Callers&quot;</span>);</span><br><span class=\"line\">  services.Configure&lt;List&lt;CallerSetting&gt;&gt;(configSection);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"The-Controller\"><a href=\"#The-Controller\" class=\"headerlink\" title=\"The Controller\"></a>The Controller</h2><p>Let’s assume we have a controller, which handles the API requests, like this:</p>\n<figure class=\"highlight c#\"><figcaption><span>MyFancyController.cs</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">MyAPIProject</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    [<span class=\"meta\">Route(<span class=\"string\">&quot;api/helloworld&quot;</span>)</span>]</span><br><span class=\"line\">    [<span class=\"meta\">ApiController</span>]</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">MyFancyAPIController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        [<span class=\"meta\">HttpGet</span>]</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"built_in\">string</span> <span class=\"title\">Get</span>()</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;Hello World&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>To prevent to write a request check against our new settings in each action method, we can decorate the whole controller class by introducing an new custom <code>Attribute</code>, which will do the work:</p>\n<figure class=\"highlight c#\"><figcaption><span>MyFancyController.cs</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"meta\">Route(<span class=\"string\">&quot;api/helloworld&quot;</span>)</span>]</span><br><span class=\"line\">[<span class=\"meta\">ApiController</span>]</span><br><span class=\"line\">[<span class=\"meta\">AuthenticateApiRequest</span>]</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">MyFancyAPIController</span> : <span class=\"title\">ControllerBase</span></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"The-Attribute\"><a href=\"#The-Attribute\" class=\"headerlink\" title=\"The Attribute\"></a>The Attribute</h2><p>Here is the code for the new attribute. It uses the <code>IActionFilter</code>. These filters run within the ASP.NET Core action invocation pipeline, in our case BEFORE the action is entered (<code>OnActionExecutionAsync</code>).</p>\n<figure class=\"highlight c#\"><figcaption><span>AuthenticateApiRequestAttribute.cs</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class=\"line\"><span class=\"keyword\">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class=\"line\"><span class=\"keyword\">using</span> Microsoft.Extensions.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Generic;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Threading.Tasks;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Linq;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">MyAPIProject</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  [<span class=\"meta\">AttributeUsage(AttributeTargets.Class)</span>]</span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">AuthenticateApiRequestAttribute</span> : <span class=\"title\">Attribute</span>, <span class=\"title\">IAsyncActionFilter</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">OnActionExecutionAsync</span></span></span><br><span class=\"line\"><span class=\"function\">    (<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">      ActionExecutingContext context, </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">      ActionExecutionDelegate next</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Get an Api Key from Request Header</span></span><br><span class=\"line\">      context.HttpContext.Request.Headers.TryGetValue(</span><br><span class=\"line\">        <span class=\"string\">&quot;ApiKey&quot;</span>, <span class=\"keyword\">out</span> <span class=\"keyword\">var</span> requestApiKey</span><br><span class=\"line\">      );</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Get the remote IP Address</span></span><br><span class=\"line\">      <span class=\"keyword\">var</span> requestIpAddress = </span><br><span class=\"line\">        context.HttpContext.Connection.RemoteIpAddress.ToString();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Get access to &#x27;appsettings.json&#x27;</span></span><br><span class=\"line\">      <span class=\"keyword\">var</span> appSettings = </span><br><span class=\"line\">        context.HttpContext.RequestServices.GetRequiredService&lt;IConfiguration&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Get &#x27;Callers&#x27; list from settings</span></span><br><span class=\"line\">      <span class=\"keyword\">var</span> callers = appSettings.GetSection(<span class=\"string\">&quot;Callers&quot;</span>)</span><br><span class=\"line\">        .Get&lt;List&lt;CallerSetting&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Get all Callers with matching IP Adress and/or API Key via LINQ</span></span><br><span class=\"line\">      <span class=\"keyword\">var</span> current = callers.Where(c =&gt; </span><br><span class=\"line\">        (c.IPAddress == requestIpAddress) || </span><br><span class=\"line\">        (c.IPAddress == <span class=\"string\">&quot;*&quot;</span> &amp;&amp; c.ApiKey == requestApiKey) ||</span><br><span class=\"line\">        (c.IPAddress == requestIpAddress &amp;&amp; c.ApiKey == requestApiKey));</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"comment\">// Do we have a match?</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (current.Count() == <span class=\"number\">0</span>)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"comment\">// No, then return with an error </span></span><br><span class=\"line\">        context.Result = <span class=\"keyword\">new</span> ContentResult()</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          StatusCode = <span class=\"number\">401</span>,</span><br><span class=\"line\">          Content = <span class=\"string\">&quot;Unauthorized Access&quot;</span></span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125; </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">await</span> next(); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"The-Result\"><a href=\"#The-Result\" class=\"headerlink\" title=\"The Result\"></a>The Result</h2><p><img src=\"/post/Custom-Caller-Authentication-with-ASP-NET-Core-5-0-WebApi/api-request-nightingale.png\" alt=\"Test Request with Nightingale\"></p>\n<h2 id=\"More-Info\"><a href=\"#More-Info\" class=\"headerlink\" title=\"More Info\"></a>More Info</h2>\n        <ul class=\"moreinfo-list\">\n            <li>Microsoft Docs: <a href=\"https://docs.microsoft.com/de-de/aspnet/core/mvc/controllers/filters?view=aspnetcore-5.0\">Filters in ASP.NET Core</a></li><li>Microsoft Docs: <a href=\"https://docs.microsoft.com/de-de/aspnet/core/fundamentals/configuration/?view=aspnetcore-5.0\">Configuration in ASP.NET Core</a></li>\n        </ul>\n    ","_path":"post/Custom-Caller-Authentication-with-ASP-NET-Core-5-0-WebApi/","_link":"https://kiko.io/post/Custom-Caller-Authentication-with-ASP-NET-Core-5-0-WebApi/","_id":"clo41jfnh0016p0ou6sax10no"}}