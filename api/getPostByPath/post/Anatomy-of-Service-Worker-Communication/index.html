{"type":"getPostByPath","data":{"title":"Anatomy of Service Worker Communication","date":"2022-11-12T11:26:34.000Z","description":"<p>I have a SPA that works as a PWA, which means that in the background a service worker makes sure that the required files for the offline mode end up in the cache.</p>\n<p>From time to time I also update the Service Worker, which defines which files it should keep offline and which not. Unfortunately, the app itself didn’t get any of this because there was no communication channel for them to talk.</p>\n<p>If you research this topic on the web, you have to dig through many architecture pages and documentations that have one thing in common: sometimes they just don’t get to the point. So here are my 50 cents on the subject and my sample implementation.</p>","categories":[{"name":"JavaScript","_id":"clit5gh0j003clsor7uyp1dmr"}],"tags":[{"name":"SPA","_id":"clit5gh1r005wlsor7zsw98yk"},{"name":"PWA","_id":"clit5gh2g007klsoreqbd5rih"}],"content":"<p>I have a SPA that works as a PWA, which means that in the background a service worker makes sure that the required files for the offline mode end up in the cache.</p>\n<p>From time to time I also update the Service Worker, which defines which files it should keep offline and which not. Unfortunately, the app itself didn’t get any of this because there was no communication channel for them to talk.</p>\n<p>If you research this topic on the web, you have to dig through many architecture pages and documentations that have one thing in common: sometimes they just don’t get to the point. So here are my 50 cents on the subject and my sample implementation.</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Preliminary-Thoughts\"><a href=\"#Preliminary-Thoughts\" class=\"headerlink\" title=\"Preliminary Thoughts\"></a>Preliminary Thoughts</h2><p>In most examples I’ve read, the authors talk about code for the app itself and code for the Service Worker, but that falls short to me, because in my opinion there are THREE parts:</p>\n<ol>\n<li>The <strong>App</strong></li>\n<li>The <strong>Service Worker</strong></li>\n<li>The <strong>Service Worker Management</strong>, which takes care of the proper registration and installation of the service worker</li>\n</ol>\n<p>The last part of the code shouldn’t be part of the app itself, in the meaning of SoC (Seperation of Concerns). It does not contribute to the functioning of the app.</p>\n<hr>\n<h2 id=\"The-App\"><a href=\"#The-App\" class=\"headerlink\" title=\"The App\"></a>The App</h2><p>Here’s the general anatomy of my App:</p>\n<figure class=\"highlight js\"><figcaption><span>app.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> app = &#123;</span><br><span class=\"line\">  <span class=\"string\">&#x27;settings&#x27;</span>: &#123; <span class=\"comment\">// some stuff on app settings</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&#x27;pages&#x27;</span>: &#123; <span class=\"comment\">// views of the SPA</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&#x27;ui&#x27;</span>: &#123; <span class=\"comment\">// some UI helper</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;dialog&#x27;</span>: <span class=\"keyword\">function</span>(<span class=\"params\">msg, title</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// show the message in a toast, popup or elsewhere</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&#x27;starter&#x27;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;init&#x27;</span>: &#123; <span class=\"comment\">// initializing of the app</span></span><br><span class=\"line\">      ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">app</span> = app;</span><br><span class=\"line\">app.<span class=\"property\">starter</span>.<span class=\"title function_\">init</span>();</span><br></pre></td></tr></table></figure>\n\n<p>Nothing unlikely, as I guess. It is built according to the composite pattern and has one entry point, that is called at the end of the file after it is instantiated.</p>\n<hr>\n<h2 id=\"The-Service-Worker\"><a href=\"#The-Service-Worker\" class=\"headerlink\" title=\"The Service Worker\"></a>The Service Worker</h2><p>The Service Worker lives in its own JS file and its implementation is really straight forward:</p>\n<figure class=\"highlight js\"><figcaption><span>service-worker.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> cacheName = <span class=\"string\">&#x27;my-apps-cache-v1.2.3&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> appFiles = [</span><br><span class=\"line\">  <span class=\"comment\">// list of app relating files, that has to be handled</span></span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> excludeUrls = [ </span><br><span class=\"line\">  <span class=\"comment\">// list if URL&#x27;s that shouldn&#x27;t be handled</span></span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\">self.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;install&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// on install, open the cache and add all appFiles</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">//activate immediatly and dont wait for connected clients to disconnect</span></span><br><span class=\"line\">  self.<span class=\"title function_\">skipWaiting</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">self.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;activate&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// remove old caches</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//say to all clients: Now I&#x27;m responsible</span></span><br><span class=\"line\">  self.<span class=\"property\">clients</span>.<span class=\"title function_\">claim</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">self.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;fetch&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// intercept requests and serve the app files out of the cache</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>I won’t go into the depth of my implementation here now, since it doesn’t matter for the message exchange. It is only good for you to know that I have versioned the cache name to exchange it with new versions.</p>\n<hr>\n<h2 id=\"The-Service-Worker-Management\"><a href=\"#The-Service-Worker-Management\" class=\"headerlink\" title=\"The Service Worker Management\"></a>The Service Worker Management</h2><p>Now the management code for the Service Worker. It has to be loaded with the app code, because it is client code and later on it needs knowledge of the app.</p>\n<figure class=\"highlight js\"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"string\">&#x27;serviceWorker&#x27;</span> <span class=\"keyword\">in</span> navigator) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  navigator.<span class=\"property\">serviceWorker</span>.<span class=\"title function_\">register</span>(<span class=\"string\">&#x27;service-worker.js&#x27;</span>)</span><br><span class=\"line\">    .<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span>(<span class=\"params\">registration</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// detect Service Worker update available</span></span><br><span class=\"line\">      registration.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;updatefound&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (registration.<span class=\"property\">installing</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">// detect install of new Service Worker</span></span><br><span class=\"line\">          registration.<span class=\"property\">installing</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;statechange&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (registration.<span class=\"property\">waiting</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"keyword\">if</span> (navigator.<span class=\"property\">serviceWorker</span>.<span class=\"property\">controller</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// there is an existing controller that has been updated</span></span><br><span class=\"line\">                <span class=\"comment\">//<span class=\"doctag\">TODO:</span> Send a message to the app</span></span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// first install</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"Lets-Communicate…\"><a href=\"#Lets-Communicate…\" class=\"headerlink\" title=\"Lets Communicate…\"></a>Lets Communicate…</h2><p>In this setup, the communication code can be implemented. Let’s do it as a round trip.</p>\n<h3 id=\"1-Client-sends-message-to-Service-Worker\"><a href=\"#1-Client-sends-message-to-Service-Worker\" class=\"headerlink\" title=\"1. Client sends message to Service Worker\"></a>1. Client sends message to Service Worker</h3><p>As <code>sw-management.js</code> represents our Service Worker management code, we add a little function to send a message in here:</p>\n<figure class=\"highlight js\"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">sendMessageToServiceWorker</span>(<span class=\"params\">type, msg</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (navigator.<span class=\"property\">serviceWorker</span>.<span class=\"property\">controller</span>) &#123;</span><br><span class=\"line\">      navigator.<span class=\"property\">serviceWorker</span>.<span class=\"property\">controller</span>.<span class=\"title function_\">postMessage</span>(</span><br><span class=\"line\">        &#123;<span class=\"string\">&#x27;type&#x27;</span>: type, <span class=\"string\">&#x27;msg&#x27;</span>: msg &#125;</span><br><span class=\"line\">      );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>We define a type for the purpose of our communcation and a message itself. The function can be called wherever, like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">sendMessageToServiceWorker</span>(<span class=\"string\">&quot;TEST&quot;</span>, <span class=\"string\">&quot;Hey, Service Worker&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-Service-Worker-receives-the-message\"><a href=\"#2-Service-Worker-receives-the-message\" class=\"headerlink\" title=\"2. Service Worker receives the message\"></a>2. Service Worker receives the message</h3><p>In the Service Worker code we need to add a recipient:</p>\n<figure class=\"highlight js\"><figcaption><span>service-worker.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">self.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">event</span>) &#123; </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!event.<span class=\"property\">data</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (event.<span class=\"property\">data</span>.<span class=\"property\">type</span> === <span class=\"string\">&#x27;TEST&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// do something regarding to the type and/or with the message</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-…-and-sends-a-message-back-to-the-client\"><a href=\"#3-…-and-sends-a-message-back-to-the-client\" class=\"headerlink\" title=\"3. … and sends a message back to the client\"></a>3. … and sends a message back to the client</h3><p>What we want to do with the message depends what we want to achive, but in this example, just let’s greet back:</p>\n<figure class=\"highlight js\"><figcaption><span>service-worker.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">sendMessageToClients</span>(<span class=\"params\">type, msg</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// as the SW can control multiple clients, we have to catch them all</span></span><br><span class=\"line\">  self.<span class=\"property\">clients</span>.<span class=\"title function_\">matchAll</span>(&#123; <span class=\"attr\">includeUncontrolled</span>: <span class=\"literal\">true</span> &#125;)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span>(<span class=\"params\">clients</span>) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> client <span class=\"keyword\">of</span> clients) &#123;</span><br><span class=\"line\">              client.<span class=\"title function_\">postMessage</span>(</span><br><span class=\"line\">                &#123;<span class=\"string\">&#x27;type&#x27;</span>: type, <span class=\"string\">&#x27;msg&#x27;</span>: msg &#125;</span><br><span class=\"line\">              );</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">self.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">event</span>) &#123; </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!event.<span class=\"property\">data</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (event.<span class=\"property\">data</span>.<span class=\"property\">type</span> === <span class=\"string\">&#x27;TEST&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">sendMessageToClients</span>(event.<span class=\"property\">data</span>.<span class=\"property\">type</span>, <span class=\"string\">&#x27;Hi Clients...&#x27;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-Client-receives-the-answer-from-the-Service-Worker\"><a href=\"#4-Client-receives-the-answer-from-the-Service-Worker\" class=\"headerlink\" title=\"4. Client receives the answer from the Service Worker\"></a>4. Client receives the answer from the Service Worker</h3><p>In order to get messages from the Service Worker, we have to implement a receiver in the client also:</p>\n<figure class=\"highlight js\"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"string\">&#x27;serviceWorker&#x27;</span> <span class=\"keyword\">in</span> navigator) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//... &#x27;navigator.serviceWorker.register&#x27; stuff</span></span><br><span class=\"line\"></span><br><span class=\"line\">  navigator.<span class=\"property\">serviceWorker</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (event.<span class=\"property\">data</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// do something with the message from the Service Worker</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-…-and-shows-it-in-the-app\"><a href=\"#5-…-and-shows-it-in-the-app\" class=\"headerlink\" title=\"5. … and shows it in the app\"></a>5. … and shows it in the app</h3><p>As I pointed out earlier, that the management code has to be loaded alongside with the app code, it’s a breeze to show the message:</p>\n<figure class=\"highlight js\"><figcaption><span>app.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> app = &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">&#x27;ui&#x27;</span>: &#123; <span class=\"comment\">// some UI helper</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;dialog&#x27;</span>: <span class=\"keyword\">function</span>(<span class=\"params\">msg, title</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// show the message in a toast, popup or elsewhere</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">app</span> = app;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight js\"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"string\">&#x27;serviceWorker&#x27;</span> <span class=\"keyword\">in</span> navigator) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//... &#x27;navigator.serviceWorker.register&#x27; stuff</span></span><br><span class=\"line\"></span><br><span class=\"line\">  navigator.<span class=\"property\">serviceWorker</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (event.<span class=\"property\">data</span>) &#123;</span><br><span class=\"line\">        app.<span class=\"property\">ui</span>.<span class=\"property\">dialog</span>.<span class=\"title function_\">info</span>(event.<span class=\"property\">data</span>.<span class=\"property\">msg</span>, <span class=\"string\">&#x27;Service Worker says...&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"The-Update-Message\"><a href=\"#The-Update-Message\" class=\"headerlink\" title=\"The Update Message\"></a>The Update Message</h2><p>With this infrastructure, everything is there to show a message, when the Service Worker is updated:</p>\n<figure class=\"highlight js\"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"string\">&#x27;serviceWorker&#x27;</span> <span class=\"keyword\">in</span> navigator) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  navigator.<span class=\"property\">serviceWorker</span>.<span class=\"title function_\">register</span>(<span class=\"string\">&#x27;service-worker.js&#x27;</span>)</span><br><span class=\"line\">    .<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span>(<span class=\"params\">registration</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// detect Service Worker update available</span></span><br><span class=\"line\">      registration.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;updatefound&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (registration.<span class=\"property\">installing</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">// detect install of new Service Worker</span></span><br><span class=\"line\">          registration.<span class=\"property\">installing</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;statechange&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (registration.<span class=\"property\">waiting</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"keyword\">if</span> (navigator.<span class=\"property\">serviceWorker</span>.<span class=\"property\">controller</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// there is an existing controller that has been updated</span></span><br><span class=\"line\"></span><br><span class=\"line\">                app.<span class=\"property\">ui</span>.<span class=\"property\">dialog</span>.<span class=\"title function_\">info</span>(<span class=\"string\">&#x27;New version installed&#x27;</span>, <span class=\"string\">&#x27;Service Worker&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// first install</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Important to point out, that the Service Worker side of the communication is not involved in this case, because only the client-side management code knows when a new version has to be installed.</p>\n<hr>\n<h2 id=\"More-Info\"><a href=\"#More-Info\" class=\"headerlink\" title=\"More Info\"></a>More Info</h2>\n        <ul class=\"moreinfo-list\">\n            <li>Jake Archibald: <a href=\"https://web.dev/service-worker-lifecycle/\">The service worker lifecycle</a></li><li>Demian Renzulli & Andrew Guan: <a href=\"https://web.dev/two-way-communication-guide/\">Two-way communication with service workers</a></li><li>Adam Bar: <a href=\"https://whatwebcando.today/articles/handling-service-worker-updates\">Handling Service Worker updates – how to keep the app updated and stay sane</a></li><li>Felix Gerschau: <a href=\"https://www.peterkroener.de/postmessage-zwischen-service-worker-und-clients/\">Service Worker Lifecycle Explained</a></li><li>Felix Gerschau: <a href=\"https://felixgerschau.com/how-to-communicate-with-service-workers/\">How to communicate with Service Workers</a></li><li>Peter Kröner: <a href=\"https://www.peterkroener.de/postmessage-zwischen-service-worker-und-clients/\">PostMessage zwischen Service Worker und Client(s) (GERMAN)</a></li>\n        </ul>\n    \n","_path":"post/Anatomy-of-Service-Worker-Communication/","_link":"https://kiko.io/post/Anatomy-of-Service-Worker-Communication/","_id":"clit5ggyd0028lsorbehw7wfy"}}