{"type":"getPostByPath","data":{"title":"Meaningful automatic versioning with T4","date":"2020-06-27T15:57:18.000Z","description":"<p>Every developer has to have an idea of versioning his products. If you work with Visual Studio you have the <code>Assembly Information</code> in the project properties dialog, to enter it manually everytime you want to release a new version:</p>\n<p><img src=\"/post/Meaningful-automatic-versioning-with-T4/AssemblyInformationDialog.png\" alt=\"Assembly Information Dialog\"></p>\n<p>The four fields are: MAJOR, MINOR, BUILD, REVISION.</p>\n<p>But seriously … who does that? I guess 99% of all C# developers are entering the <code>AssemblyInfo.cs</code> and enter the famous 2 asterisks into the version declaration of BUILD and REVISION, to let Visual Studio do the incrementation job:</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">assembly: AssemblyVersion(<span class=\"string\">&quot;1.0.*.*&quot;</span>)</span>]</span><br><span class=\"line\">[<span class=\"meta\">assembly: AssemblyFileVersion(<span class=\"string\">&quot;1.0.*.*&quot;</span>)</span>]</span><br></pre></td></tr></table></figure>\n\n<p>But this is not the end of the possibilities … Let’s do it more meaningful, with some goodies and still automatic…</p>","categories":[{"name":".NET","_id":"clmj94hc3004xkjq3dzj4fz25"}],"tags":[{"name":"Visual Studio","_id":"clmj94hc3004wkjq3ha3e0mky"},{"name":"Versioning","_id":"clmj94hd90070kjq308spe6gm"},{"name":"T4","_id":"clmj94hda0072kjq3164q0t5a"}],"content":"<p>Every developer has to have an idea of versioning his products. If you work with Visual Studio you have the <code>Assembly Information</code> in the project properties dialog, to enter it manually everytime you want to release a new version:</p>\n<p><img src=\"/post/Meaningful-automatic-versioning-with-T4/AssemblyInformationDialog.png\" alt=\"Assembly Information Dialog\"></p>\n<p>The four fields are: MAJOR, MINOR, BUILD, REVISION.</p>\n<p>But seriously … who does that? I guess 99% of all C# developers are entering the <code>AssemblyInfo.cs</code> and enter the famous 2 asterisks into the version declaration of BUILD and REVISION, to let Visual Studio do the incrementation job:</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"meta\">assembly: AssemblyVersion(<span class=\"string\">&quot;1.0.*.*&quot;</span>)</span>]</span><br><span class=\"line\">[<span class=\"meta\">assembly: AssemblyFileVersion(<span class=\"string\">&quot;1.0.*.*&quot;</span>)</span>]</span><br></pre></td></tr></table></figure>\n\n<p>But this is not the end of the possibilities … Let’s do it more meaningful, with some goodies and still automatic…</p>\n<span id=\"more\"></span>\n\n<h2 id=\"More-informative-versioning\"><a href=\"#More-informative-versioning\" class=\"headerlink\" title=\"More informative versioning\"></a>More informative versioning</h2><p>A build with an increased MAJOR version number means, that there are significant changes in the product, even breaking changes. This always should be set manually.</p>\n<p>Also the MINOR. It stands for significant functional extensions of the product.</p>\n<p>How does Visual Studio calculate BUILD and REVISION?</p>\n<blockquote><p>When specifying a version, you have to at least specify major. If you specify major and minor, you can specify an asterisk for build. This will cause <strong>build</strong> to be equal to the <strong>number of days since January 1, 2000 local time</strong>, and for <strong>revision</strong> to be equal to the <strong>number of seconds since midnight local time, divided by 2</strong>.</p>\n</blockquote>\n\n<p>But, the BUILD number should explain, how often a software with a particular MAJOR.MINOR has been build, due to minor changes and bug fixes.</p>\n<p>The “Asterisk” REVISION number is a little weird, but at least with the BUILD number unique. But it says nothing. Better to pick up the idea of a date calculated, unique number, but not an arbitrary date … let’s take the date the project has started.</p>\n<p>For example: <strong>1.2.16.158</strong> … reads version 1.2 with 16 builds on the 158’th day after the project has started.</p>\n<h2 id=\"Start-with-T4\"><a href=\"#Start-with-T4\" class=\"headerlink\" title=\"Start with T4\"></a>Start with T4</h2><p>T4 (Text Template Transformation Toolkit) is a templating system in Visual Studio for generating text files during design time. It is very suitable to even generate code. Read about it <a href=\"https://docs.microsoft.com/en-us/visualstudio/modeling/code-generation-and-t4-text-templates\">here</a> and <a href=\"https://docs.microsoft.com/en-us/visualstudio/modeling/writing-a-t4-text-template\">here</a>.</p>\n<p>A Text Template (.tt) has <strong>Directives</strong> (how the template is processed), <strong>Text blocks</strong> (text copied to the output) and <strong>Control blocks</strong> (program code).</p>\n<p>For our versioning template, we start with this in a new file named <strong><code>AssemblyVersion.tt</code></strong>:</p>\n<p><em>Directives</em>:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;#@ template hostspecific=&quot;true&quot; language=&quot;C#&quot; #&gt;</span><br><span class=\"line\">&lt;#@ output extension=&quot;.cs&quot; #&gt;</span><br></pre></td></tr></table></figure>\n\n<p><em>Control block</em>:</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"meta\">#</span></span><br><span class=\"line\">  <span class=\"built_in\">int</span> major = <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"built_in\">int</span> minor = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">int</span> build = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">int</span> revision = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"meta\">#&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><em>Text block</em>:</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This code was generated by a tool. Any changes made manually will be lost</span></span><br><span class=\"line\"><span class=\"comment\">// the next time this code is regenerated.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Reflection;</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"meta\">assembly: AssemblyVersion(<span class=\"string\">&quot;&lt;#= $&quot;</span>&#123;major&#125;.&#123;minor&#125;.&#123;build&#125;.&#123;revision&#125;<span class=\"string\">&quot; #&gt;&quot;</span>)</span>]</span><br><span class=\"line\">[<span class=\"meta\">assembly: AssemblyFileVersion(<span class=\"string\">&quot;&lt;#= $&quot;</span>&#123;major&#125;.&#123;minor&#125;.&#123;build&#125;.&#123;revision&#125;<span class=\"string\">&quot; #&gt;&quot;</span>)</span>]</span><br></pre></td></tr></table></figure>\n\n<p>On saving the TT file, a new CS file with the same name will be created automatically and you got an error like this:</p>\n<p><img src=\"/post/Meaningful-automatic-versioning-with-T4/DuplicateAttributes.png\" alt=\"Duplicate Attributes Error\"></p>\n<h3 id=\"A-new-place-for-version-info\"><a href=\"#A-new-place-for-version-info\" class=\"headerlink\" title=\"A new place for version info\"></a>A new place for version info</h3><p>Th error occurs, because we have now <strong>two</strong> <code>AssemblyVersion</code> and <code>AssemblyFileVersion</code> attributes in our project. We need to comment out the original in <code>Properties\\AssemblyInfo.cs</code>:</p>\n<p><img src=\"/post/Meaningful-automatic-versioning-with-T4/ChangeAssemblyInfo.png\" alt=\"Change AssemblyInfo.cs\"></p>\n<h3 id=\"Structural-Considerations\"><a href=\"#Structural-Considerations\" class=\"headerlink\" title=\"Structural Considerations\"></a>Structural Considerations</h3><p>It makes sense to store all needed files for the new versioning system in a new root folder of the project, named <strong>AssemblyVersion</strong>, starting with the <code>AssemblyVersion.tt</code>, because there will be more files later on.</p>\n<h2 id=\"New-app-information-file\"><a href=\"#New-app-information-file\" class=\"headerlink\" title=\"New app information file\"></a>New app information file</h2><p>As we replaced the original version attributes in the project with those from our generated  <code>AssemblyVersion.cs</code>, we cannot control the MAJOR and MINOR version number via the project property dialog any longer. We need a new approach on that, which can be edited easily and processed automatically.</p>\n<h3 id=\"AssemblyVersion-json\"><a href=\"#AssemblyVersion-json\" class=\"headerlink\" title=\"AssemblyVersion.json\"></a>AssemblyVersion.json</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;initialDate&quot;</span>: <span class=\"string\">&quot;2019-09-29&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;versions&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;major&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;minor&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;releaseDate&quot;</span>: <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;remarks&quot;</span>: <span class=\"string\">&quot;Some cool new features; New versioning system&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;major&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;minor&quot;</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;releaseDate&quot;</span>: <span class=\"string\">&quot;2019-10-01&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;remarks&quot;</span>: <span class=\"string\">&quot;Initial Release&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>This new JSON file has two main items:</p>\n<ul>\n<li><code>initialDate</code> - the date the project has started, to calculate the REVISION later on</li>\n<li><code>versions</code> - a list with all different MAJOR&#x2F;MINOR versions we have done so far, with at least one without a release date … the one with the highest <code>major</code> and <code>minor</code>.</li>\n</ul>\n<p>The <code>remarks</code> attribute of a list item holds some information about the changes in a new version. Together with <code>releaseDate</code>, useful for a possible release history, shown in the product itself.</p>\n<h3 id=\"Library-references-in-T4\"><a href=\"#Library-references-in-T4\" class=\"headerlink\" title=\"Library references in T4\"></a>Library references in T4</h3><p>T4 runs in its own app domain, therefore it can use built-in libraries as <code>System.IO</code>, but not third-party libraries like <code>Newtonsoft.JSON</code>. </p>\n<p>We could reference those libraries from the projects package folder via the absolute path (if we use it in our product), but when we are running a NuGet update, the reference will break. </p>\n<p>It is advisable to store such libraries directly in a fixed folder, like <strong>AssemblyVersion\\Libraries</strong>. They won’t have any impact to our product, because the are only used while design time.</p>\n<h2 id=\"The-MAJOR-and-MINOR\"><a href=\"#The-MAJOR-and-MINOR\" class=\"headerlink\" title=\"The MAJOR and MINOR\"></a>The MAJOR and MINOR</h2><p>To process the new <code>AssemblyVersion.json</code> in the template, we need some new directives for referencing the needed libraries and the import of the appropriate namepaces:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;#@ assembly name=&quot;System.Core&quot; #&gt;</span><br><span class=\"line\">&lt;#@ assembly name=&quot;$(SolutionDir)\\AssemblyVersion\\Libraries\\Newtonsoft.Json.dll&quot; #&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;#@ import namespace=&quot;System.IO&quot; #&gt;</span><br><span class=\"line\">&lt;#@ import namespace=&quot;System.Linq&quot; #&gt;</span><br><span class=\"line\">&lt;#@ import namespace=&quot;Newtonsoft.Json&quot; #&gt;</span><br></pre></td></tr></table></figure>\n\n<p>Via the use of the T4 variable <code>$(SolutionDir)</code>, we can point to our copy of Newtonsoft JSON.</p>\n<p>Now we can read and convert the JSON into an anonymous object and get the highest values of MAJOR and MINOR:</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"meta\">#</span></span><br><span class=\"line\">    <span class=\"built_in\">string</span> avPath = <span class=\"keyword\">this</span>.Host.ResolvePath(<span class=\"string\">&quot;AssemblyVersion.json&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">string</span> avJson = File.ReadAllText(avPath);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> avDefinition = <span class=\"keyword\">new</span> &#123;</span><br><span class=\"line\">        initialDate = <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">        versions = <span class=\"keyword\">new</span> [] &#123;</span><br><span class=\"line\">            <span class=\"keyword\">new</span> &#123;</span><br><span class=\"line\">                major = <span class=\"number\">0</span>,</span><br><span class=\"line\">                minor = <span class=\"number\">0</span>,</span><br><span class=\"line\">                releaseDate = <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">                remarks = <span class=\"string\">&quot;&quot;</span> &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> avObject = JsonConvert.DeserializeAnonymousType(avJson, avDefinition);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Get highest Major/Minor from versions list</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> maxVersion = avObject.versions</span><br><span class=\"line\">      .OrderByDescending(i =&gt; i.major)</span><br><span class=\"line\">      .ThenByDescending(j =&gt; j.minor)</span><br><span class=\"line\">      .First();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Set MAJOR</span></span><br><span class=\"line\">    <span class=\"built_in\">int</span> major = maxVersion.major;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Set MINOR</span></span><br><span class=\"line\">    <span class=\"built_in\">int</span> minor = maxVersion.minor;</span><br><span class=\"line\"><span class=\"meta\">#&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"The-BuildLog\"><a href=\"#The-BuildLog\" class=\"headerlink\" title=\"The BuildLog\"></a>The BuildLog</h2><p>In order to get the version number for BUILD, we need a method to count and store every build that has been run, separated by the MAJOR&#x2F;MINOR versions. This is a job for a <strong>Post-build event</strong>, which can be configured in the project properties dialog. The event uses shell commands as they are used on the command line.</p>\n<p>What the commands should do:&nbsp;&nbsp;&nbsp;Write a new line with the current date and time in a log file, named after the MAJOR&#x2F;MINOR version and stored in the folder <strong>AssemblyVersion\\BuildLogs</strong>.</p>\n<p><img src=\"/post/Meaningful-automatic-versioning-with-T4/BuildLog.png\" alt=\"Build Log\"></p>\n<h3 id=\"Extending-build-event-macros\"><a href=\"#Extending-build-event-macros\" class=\"headerlink\" title=\"Extending build event macros\"></a>Extending build event macros</h3><p>Shell commands for build events are supporting built-in variables, so called ‘macros’, like <code>$(ProjectDir)</code> (which returns the project directory path), but there is no such macro for the current version number. We have to introduce it via extending the project with a new build target.</p>\n<p>Unload the project in Visual Studio for editing the CSPROJ (or VBPROJ) file of your product manually and write the following definition just before the end-tag:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">PropertyGroup</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">PostBuildEventDependsOn</span>&gt;</span></span><br><span class=\"line\">    $(PostBuildEventDependsOn);</span><br><span class=\"line\">    PostBuildMacros;</span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">PostBuildEventDependsOn</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">PropertyGroup</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Target</span> <span class=\"attr\">Name</span>=<span class=\"string\">&quot;PostBuildMacros&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">GetAssemblyIdentity</span> <span class=\"attr\">AssemblyFiles</span>=<span class=\"string\">&quot;$(TargetPath)&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Output</span> <span class=\"attr\">TaskParameter</span>=<span class=\"string\">&quot;Assemblies&quot;</span> <span class=\"attr\">ItemName</span>=<span class=\"string\">&quot;Targets&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">GetAssemblyIdentity</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">ItemGroup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">VersionNumber</span> <span class=\"attr\">Include</span>=<span class=\"string\">&quot;@(Targets-&gt;&#x27;%(Version)&#x27;)&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">ItemGroup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Target</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>After reloading the project in Visual Studio, we can use <code>@(VersionNumber)</code> in our commands.</p>\n<h3 id=\"CreateBuildLog-bat\"><a href=\"#CreateBuildLog-bat\" class=\"headerlink\" title=\"CreateBuildLog.bat\"></a>CreateBuildLog.bat</h3><p>The event build editor is not very comfortable, so we create the batch file <code>CreateBuildLog.bat</code> in our <strong>AssemblyVersion</strong> folder and use this as the post build event command.</p>\n\n    <div class=\"alertbox alertbox-exclamation\">\n      <p>The BuildLog folder must exist, before running the following command the first time!</p>\n\n    </div>\n  \n\n<figure class=\"highlight bat\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@<span class=\"built_in\">echo</span> off</span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">REM --Get parameters</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> PROJECT_DIR=%<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> VERSION_NUMBER=%<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">REM --Set what to log</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> LOG_LINE=<span class=\"variable\">%DATE%</span> <span class=\"variable\">%TIME%</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">REM --Inform the user</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> MSG=CreateBuildLog &#x27;<span class=\"variable\">%LOG_LINE%</span>&#x27; <span class=\"keyword\">for</span> version <span class=\"variable\">%VERSION_NUMBER%</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">%MSG%</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">REM --Get version parts</span></span><br><span class=\"line\"><span class=\"keyword\">FOR</span> /f &quot;tokens=<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span> delims=.&quot; <span class=\"variable\">%%a</span> <span class=\"keyword\">IN</span> (&quot;<span class=\"variable\">%VERSION_NUMBER%</span>&quot;) <span class=\"keyword\">do</span> (</span><br><span class=\"line\">\t<span class=\"built_in\">set</span> MAJOR=<span class=\"variable\">%%a</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span> MINOR=<span class=\"variable\">%%b</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span> BUILD=<span class=\"variable\">%%c</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span> REVISION=<span class=\"variable\">%%d</span></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">REM --Define BuildLog file and folder </span></span><br><span class=\"line\"><span class=\"built_in\">set</span> BUILDLOG_FILE=<span class=\"variable\">%MAJOR%</span>.<span class=\"variable\">%MINOR%</span>.log</span><br><span class=\"line\"><span class=\"built_in\">set</span> BUILDLOG_FOLDER=<span class=\"variable\">%PROJECT_DIR%</span>\\AssemblyVersion\\BuildLogs</span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">REM --Write current date and time as new line in the file</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">%LOG_LINE%</span> &gt;&gt; <span class=\"variable\">%BUILDLOG_FOLDER%</span>\\<span class=\"variable\">%BUILDLOG_FILE%</span>&quot;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/post/Meaningful-automatic-versioning-with-T4/PostBuildEvent.png\" alt=\"Post Build Event\"></p>\n<figure class=\"highlight bat\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;$(ProjectDir)\\AssemblyVersion\\CreateBuildLog.bat&quot; &quot;$(ProjectDir)&quot; @(VersionNumber)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"The-BUILD\"><a href=\"#The-BUILD\" class=\"headerlink\" title=\"The BUILD\"></a>The BUILD</h2><p>As we have now the BuildLogs, we can use them in the template:</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"meta\">#</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Get BuildLog of max version</span></span><br><span class=\"line\">    <span class=\"built_in\">string</span> buildlogFolder = <span class=\"keyword\">this</span>.Host.ResolvePath(<span class=\"string\">&quot;BuildLogs&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">string</span> buildLog = </span><br><span class=\"line\">      buildlogFolder + <span class=\"string\">&quot;\\\\&quot;</span> +</span><br><span class=\"line\">      maxVersion.major + <span class=\"string\">&quot;.&quot;</span> +</span><br><span class=\"line\">      maxVersion.minor + <span class=\"string\">&quot;.log&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Get number of lines from BuildLog or create a new log (!)</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> buildCount = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (File.Exists(buildLog)) &#123;</span><br><span class=\"line\">        buildCount = File.ReadLines(buildLog).Count() + <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        File.Create(buildLog).Dispose();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Set BUILD</span></span><br><span class=\"line\">    <span class=\"built_in\">int</span> build = buildCount;</span><br><span class=\"line\"><span class=\"meta\">#&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Very important is to create the log file, if it doesn’t exists! Otherwise the build will always fail, because the version attributes can’t be created.</p>\n<h2 id=\"The-REVISION\"><a href=\"#The-REVISION\" class=\"headerlink\" title=\"The REVISION\"></a>The REVISION</h2><p>At least we have to set the REVISION number, by calculating the difference between the current date and the <code>initialDate</code>, which we have previously read from the <code>AssemblyVersion.json</code>:</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"meta\">#</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//Set REVISION</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> dateCreated = DateTime.Parse(avObject.initialDate);</span><br><span class=\"line\">    <span class=\"built_in\">int</span> revision = (DateTime.Now.Date - dateCreated.Date).Days;</span><br><span class=\"line\"><span class=\"meta\">#&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Transforming-T4-template-on-build\"><a href=\"#Transforming-T4-template-on-build\" class=\"headerlink\" title=\"Transforming T4 template on build\"></a>Transforming T4 template on build</h2><p>The last hurdle is to run the text transformation every time you build your product. Until now it runs only on saving the <code>AssemblyVersion.tt</code>.</p>\n<p>A great helper on that was Thomas Levesque’s post <a href=\"https://thomaslevesque.com/2017/11/13/transform-t4-templates-as-part-of-the-build-and-pass-variables-from-the-project/\">“Transform T4 templates as part of the build, and pass variables from the project”</a>, where he describes every difficulty to reach this goal.</p>\n<p>To make it short: We have to edit the CSPROJ file again, to introduce TextTemplating to MSBuild.</p>\n<p>First we need following near the beginning of the projects XML:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">PropertyGroup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">VisualStudioVersion</span> <span class=\"attr\">Condition</span>=<span class=\"string\">&quot;&#x27;$(VisualStudioVersion)&#x27; == &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">      16.0</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">VisualStudioVersion</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">VSToolsPath</span> <span class=\"attr\">Condition</span>=<span class=\"string\">&quot;&#x27;$(VSToolsPath)&#x27; == &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">      $(MSBuildExtensionsPath32)\\Microsoft\\VisualStudio\\v$(VisualStudioVersion)</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">VSToolsPath</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TransformOnBuild</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">TransformOnBuild</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">OverwriteReadOnlyOutputFiles</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">OverwriteReadOnlyOutputFiles</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TransformOutOfDateOnly</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">TransformOutOfDateOnly</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">PropertyGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Secondly add the IMPORT of the TextTemplating target AFTER the CSharp target:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Import</span> <span class=\"attr\">Project</span>=<span class=\"string\">&quot;$(MSBuildToolsPath)\\Microsoft.CSharp.targets&quot;</span> /&gt;</span></span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Import</span> <span class=\"attr\">Project</span>=<span class=\"string\">&quot;$(VSToolsPath)\\TextTemplating\\Microsoft.TextTemplating.targets&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>If you build your product now, a new build log is created and the version numbers BUILD and REVISION are automatically increased.</p>\n<h2 id=\"See-it-in-action\"><a href=\"#See-it-in-action\" class=\"headerlink\" title=\"See it in action\"></a>See it in action</h2><p>The project where I implemented this versioning first is <a href=\"https://github.com/kristofzerbe/HexoCommander\">HexoCommander</a>. Feel free to download the code and see how the new versioning mechanism works.</p>\n<p><img src=\"/post/Meaningful-automatic-versioning-with-T4/screencast-build-hexocommander.gif\" alt=\"Screencast Build HexoCommander\"></p>\n<p>Enjoy versioning…</p>\n","_path":"post/Meaningful-automatic-versioning-with-T4/","_link":"https://kiko.io/post/Meaningful-automatic-versioning-with-T4/","_id":"clmj94h86000wkjq3608d7omc"}}