{"type":"getPostByPath","data":{"title":"Uups ... empty posts","date":"2021-09-21T11:40:25.000Z","description":"<p>A while ago I wrote about <a href=\"/post/Automatic-Duplicate-Image-Shadow/\" title=\"Automatic Duplicate Image Shadow\">Automatic Duplicate Image Shadow</a> and used <a href=\"https://indiepen.tech/\">indiepen</a> for showing the result of my efforts.</p>\n\n    <div class=\"alertbox alertbox-note\">\n      <p><strong><a href=\"https://indiepen.tech/\">indiepen</a></strong> is a solution for showing code samples without the need of a code sharing platform, like <a href=\"https://codepen.io/\">codepen</a>. Just reference a <code>index.html</code>, <code>main.js</code> and <code>styles.css</code> from wherever you want and indiepen is wrapping it with a neat viewer inside an IFrame.</p>\n\n    </div>\n  \n\n<p>I did it quick and dirty first (sample files in a static folder) and now it was the time to do it right: place the sample files in a subfolder of the post in my Hexo-driven blog solution, in order to reference it from there AND have the possibility to call it directly via <code>./post/my-post/sample</code>.</p>\n<p>The key to achive that in Hexo is the configuration option <code>post_asset_folder: true</code>, which generates a subfolder for all assets with the same name as the post.</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">|- _posts</span><br><span class=\"line\">   |- my-blog-post</span><br><span class=\"line\">      |- my-first-asset.jpg</span><br><span class=\"line\">      |- my-second-asset.jpg</span><br><span class=\"line\">   |- my-blog-post.md</span><br></pre></td></tr></table></figure>\n\n<p>My idea regarding the indiepen files was having a subfolder for each indiepen in the post asset folder:</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">|- _posts</span><br><span class=\"line\">   |- my-blog-post</span><br><span class=\"line\">      |- my-first-asset.jpg</span><br><span class=\"line\">      |- my-second-asset.jpg</span><br><span class=\"line\">NEW   |- sample</span><br><span class=\"line\">NEW      |- index.html</span><br><span class=\"line\">NEW      |- main.js</span><br><span class=\"line\">NEW      |- styles.css</span><br><span class=\"line\">   |- my-blog-post.md</span><br></pre></td></tr></table></figure>\n\n<p>Run <code>hexo generate</code>, check that the indiepen was showing up properly and I thought I was done. Wrong … after commiting my changes to Github, where my blog is living, and checking my RSS feed a while after, I saw this:</p>\n<p><img src=\"/post/Uups-empty-posts/feed-empty-posts.png\" alt=\"Empty posts in feedly\"></p>\n<p>Three empty posts…!?</p>","categories":[{"name":"Tools","_id":"cllzod0d7003bmkoqgi75g1j4"}],"tags":[{"name":"Hexo","_id":"cllzod0d50038mkoq9ubeg20l"},{"name":"Blogging","_id":"cllzod0dg003tmkoq9n3x2bjp"}],"content":"<p>A while ago I wrote about <a href=\"/post/Automatic-Duplicate-Image-Shadow/\" title=\"Automatic Duplicate Image Shadow\">Automatic Duplicate Image Shadow</a> and used <a href=\"https://indiepen.tech/\">indiepen</a> for showing the result of my efforts.</p>\n\n    <div class=\"alertbox alertbox-note\">\n      <p><strong><a href=\"https://indiepen.tech/\">indiepen</a></strong> is a solution for showing code samples without the need of a code sharing platform, like <a href=\"https://codepen.io/\">codepen</a>. Just reference a <code>index.html</code>, <code>main.js</code> and <code>styles.css</code> from wherever you want and indiepen is wrapping it with a neat viewer inside an IFrame.</p>\n\n    </div>\n  \n\n<p>I did it quick and dirty first (sample files in a static folder) and now it was the time to do it right: place the sample files in a subfolder of the post in my Hexo-driven blog solution, in order to reference it from there AND have the possibility to call it directly via <code>./post/my-post/sample</code>.</p>\n<p>The key to achive that in Hexo is the configuration option <code>post_asset_folder: true</code>, which generates a subfolder for all assets with the same name as the post.</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">|- _posts</span><br><span class=\"line\">   |- my-blog-post</span><br><span class=\"line\">      |- my-first-asset.jpg</span><br><span class=\"line\">      |- my-second-asset.jpg</span><br><span class=\"line\">   |- my-blog-post.md</span><br></pre></td></tr></table></figure>\n\n<p>My idea regarding the indiepen files was having a subfolder for each indiepen in the post asset folder:</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">|- _posts</span><br><span class=\"line\">   |- my-blog-post</span><br><span class=\"line\">      |- my-first-asset.jpg</span><br><span class=\"line\">      |- my-second-asset.jpg</span><br><span class=\"line\">NEW   |- sample</span><br><span class=\"line\">NEW      |- index.html</span><br><span class=\"line\">NEW      |- main.js</span><br><span class=\"line\">NEW      |- styles.css</span><br><span class=\"line\">   |- my-blog-post.md</span><br></pre></td></tr></table></figure>\n\n<p>Run <code>hexo generate</code>, check that the indiepen was showing up properly and I thought I was done. Wrong … after commiting my changes to Github, where my blog is living, and checking my RSS feed a while after, I saw this:</p>\n<p><img src=\"/post/Uups-empty-posts/feed-empty-posts.png\" alt=\"Empty posts in feedly\"></p>\n<p>Three empty posts…!?</p>\n<span id=\"more\"></span>\n\n<hr>\n<p><strong>The indiepen files in the asset subfolder were treated like posts by Hexo by no obvious reason!</strong> A short research on the web lead me to a Github issue called <a href=\"https://github.com/hexojs/hexo/issues/1490\">asset files were rendered when post_asset_folder set to true</a> from 2015, with several requests to fix the bug.</p>\n<p>Since I’m little familiar with Hexo’s processors, I saw two ways to fix the problem:</p>\n<ol>\n<li>Write a plugin like <a href=\"https://github.com/printempw/hexo-hide-posts\">Hexo Hide Posts</a> to filter out unwanted “posts” after processing</li>\n<li>Try to find the problem in Hexo’s source code, to avoid these files to be treated as posts a priori</li>\n</ol>\n<p>After a little searching around in Hexo’s source code, I was able to identify the location where the problem was. In the post processor:</p>\n<figure class=\"highlight js\"><figcaption><span>./node_modules/hexo/lib/plugins/processor/post.js (shortened)</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span> = <span class=\"function\"><span class=\"params\">ctx</span> =&gt;</span> &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">pattern</span>: <span class=\"keyword\">new</span> <span class=\"title class_\">Pattern</span>(<span class=\"function\"><span class=\"params\">path</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"title function_\">isTmpFile</span>(path)) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">let</span> result;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (path.<span class=\"title function_\">startsWith</span>(postDir)) &#123;</span><br><span class=\"line\">        result = &#123;</span><br><span class=\"line\">          <span class=\"attr\">published</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">          <span class=\"attr\">path</span>: path.<span class=\"title function_\">substring</span>(postDir.<span class=\"property\">length</span>)</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (path.<span class=\"title function_\">startsWith</span>(draftDir)) &#123;</span><br><span class=\"line\">        result = &#123;</span><br><span class=\"line\">          <span class=\"attr\">published</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">          <span class=\"attr\">path</span>: path.<span class=\"title function_\">substring</span>(draftDir.<span class=\"property\">length</span>)</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!result || <span class=\"title function_\">isHiddenFile</span>(result.<span class=\"property\">path</span>)) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      result.<span class=\"property\">renderable</span> = ctx.<span class=\"property\">render</span>.<span class=\"title function_\">isRenderable</span>(path) &amp;&amp; !<span class=\"title function_\">isMatch</span>(path, ctx.<span class=\"property\">config</span>.<span class=\"property\">skip_render</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;),</span><br><span class=\"line\">    <span class=\"attr\">process</span>: <span class=\"keyword\">function</span> <span class=\"title function_\">postProcessor</span>(<span class=\"params\">file</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (file.<span class=\"property\">params</span>.<span class=\"property\">renderable</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_\">processPost</span>(file);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ctx.<span class=\"property\">config</span>.<span class=\"property\">post_asset_folder</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_\">processAsset</span>(file);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>In the very beginning of processing posts, the code iterates over all files and folders in the <code>_posts</code> folder and creates a <code>param</code> object for each by using the <code>pattern</code>. This object has an attribute named <code>renderable</code>, which is used by the <code>process</code> method later on, to decide if it has to be rendered or not.</p>\n<p>But … the determination of <code>renderable</code> is based solely on wether a file has a renderer (<em>isRenderable</em>) or if it is listed in the <code>skip_render</code> configuration. See line 24 in the sample code. As HTML, JS and CSS files naturally have a renderer in Hexo, they will treated as posts!</p>\n<hr>\n<h2 id=\"Alleviation-Of-The-Problem\"><a href=\"#Alleviation-Of-The-Problem\" class=\"headerlink\" title=\"Alleviation Of The Problem\"></a>Alleviation Of The Problem</h2><p>In this early stage of code execution, only files and folders are listed. There is no reference to a post or something like that, in order to find out if a certain file belongs to a post as an asset. Examination of the path will fail, because it is possible in Hexo to have a folder hierarchy under <code>_posts</code>.</p>\n<p>The only way to approach the problem solution is by making assumptions:</p>\n<ol>\n<li>If the user has activated the configuration <code>post_asset_folder</code>, he wants to have asset files in a folder named after the post</li>\n<li>If the user has configured a certain file name for new posts in <code>new_post_name</code> (for example <em>:title.md</em>), it is not to be assumed, that he will create asset files with the same file extension.</li>\n</ol>\n<p>Important here is, that it is not an option to hide the files in some way, because then they won’t appear in the website. They have to be marked as <em>process it, but don’t render it</em>, by bending the <code>renderable</code> attribute.</p>\n<p>These considerations led to a small extension of the above code below line 24:</p>\n<figure class=\"highlight js\"><figcaption><span>./node_modules/hexo/lib/plugins/processor/post.js (shortened)</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">result.<span class=\"property\">renderable</span> = ctx.<span class=\"property\">render</span>.<span class=\"title function_\">isRenderable</span>(path) &amp;&amp; !<span class=\"title function_\">isMatch</span>(path, ctx.<span class=\"property\">config</span>.<span class=\"property\">skip_render</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//if post_asset_folder is set, restrict renderable files to default file extension </span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (result.<span class=\"property\">renderable</span> &amp;&amp; ctx.<span class=\"property\">config</span>.<span class=\"property\">post_asset_folder</span>) &#123;</span><br><span class=\"line\">  result.<span class=\"property\">renderable</span> = (<span class=\"title function_\">extname</span>(ctx.<span class=\"property\">config</span>.<span class=\"property\">new_post_name</span>) === <span class=\"title function_\">extname</span>(path));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>This is what I pushed as a <a href=\"https://github.com/hexojs/hexo/pull/4781\">Pull Request</a> to the Hexo team today. I know, it not ideal, but maybe they accept my approach and ship the fix with the next version.</p>\n","_path":"post/Uups-empty-posts/","_link":"https://kiko.io/post/Uups-empty-posts/","_id":"cllzod0b60026mkoq94ueh62z"}}