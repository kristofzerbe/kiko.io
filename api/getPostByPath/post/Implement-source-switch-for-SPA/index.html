{"type":"getPostByPath","data":{"title":"Implement source switch for SPA","date":"2020-10-04T15:01:02.000Z","description":"<p>A while ago I wrote a Single Page Application (SPA) with jQuery and and decided to use some useful plugins to avoid reinventing the wheel. To keep the delivered sources small, I used the bundler <a href=\"https://gulpjs.com/\">Gulp</a>, to pack all JS plugins in a single file and another one for my custom JS code. I used the same procedure with the CSS files.</p>\n<p>The SPA contained only a single HTML file in which all bundeled sources and needed HTML template blocks were included, in order to load most of the stuff while starting the app, when the users sees a GMail-like  loading screen.</p>\n<p>But the whole thing had one disadvantage: Debugging for example in Chrome Dev Tool is not a joy, if the code is packed with <a href=\"https://www.npmjs.com/package/gulp-concat\">Gulp Concat</a> and <a href=\"https://www.npmjs.com/package/gulp-concat\">Gulp Uglify</a>. It would be much more convenient, if the source loading can be done depending on the environment.</p>","categories":[{"name":"JavaScript","_id":"cljel57ws003chqoz2p1l7dr4"}],"tags":[{"name":"SPA","_id":"cljel57y0005whqoz17jw7qgi"},{"name":"Bundling","_id":"cljel57y1005zhqozejvl7enk"}],"content":"<p>A while ago I wrote a Single Page Application (SPA) with jQuery and and decided to use some useful plugins to avoid reinventing the wheel. To keep the delivered sources small, I used the bundler <a href=\"https://gulpjs.com/\">Gulp</a>, to pack all JS plugins in a single file and another one for my custom JS code. I used the same procedure with the CSS files.</p>\n<p>The SPA contained only a single HTML file in which all bundeled sources and needed HTML template blocks were included, in order to load most of the stuff while starting the app, when the users sees a GMail-like  loading screen.</p>\n<p>But the whole thing had one disadvantage: Debugging for example in Chrome Dev Tool is not a joy, if the code is packed with <a href=\"https://www.npmjs.com/package/gulp-concat\">Gulp Concat</a> and <a href=\"https://www.npmjs.com/package/gulp-concat\">Gulp Uglify</a>. It would be much more convenient, if the source loading can be done depending on the environment.</p>\n<span id=\"more\"></span>\n\n<p>First step was to replace the SCRIPT and LINK tags in die <code>index.html</code> with a dynamic loading approach using JavaScript.</p>\n<h2 id=\"Dynamic-JS-loading\"><a href=\"#Dynamic-JS-loading\" class=\"headerlink\" title=\"Dynamic JS loading\"></a>Dynamic JS loading</h2><p>For some custom code it was necessary to load the plugins previously, because of dependencies.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">addScriptAsync</span>(<span class=\"params\">url</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span>(<span class=\"params\">resolve, reject</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> script = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&quot;script&quot;</span>);</span><br><span class=\"line\">    script.<span class=\"property\">type</span> = <span class=\"string\">&quot;text/javascript&quot;</span>;</span><br><span class=\"line\">    script.<span class=\"property\">src</span> = url;</span><br><span class=\"line\"></span><br><span class=\"line\">    script.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;load&quot;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(script);</span><br><span class=\"line\">    &#125;, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    script.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;error&quot;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">reject</span>(script);</span><br><span class=\"line\">    &#125;, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;head&#x27;</span>)[<span class=\"number\">0</span>].<span class=\"title function_\">appendChild</span>(script);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>By returning a <code>Promise</code>, the calling code is able to wait for a dependent source to load:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">addScriptAsync</span>(<span class=\"string\">&quot;Build/vendor.min.js&quot;</span>).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"title function_\">addScriptAsync</span>(<span class=\"string\">&quot;Build/custom.min.js&quot;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Dynamic-CSS-loading\"><a href=\"#Dynamic-CSS-loading\" class=\"headerlink\" title=\"Dynamic CSS loading\"></a>Dynamic CSS loading</h2><p>Loading CSS is pretty straightforward and includes an <code>id</code> as parameter, in order to be able to access the style afterwards, for example when tehh user is chanhing the SPAâ€™s theme: </p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">addStylesheet</span>(<span class=\"params\">url, id</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> stylesheet = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;link&#x27;</span>);</span><br><span class=\"line\">  stylesheet.<span class=\"property\">rel</span> = <span class=\"string\">&#x27;stylesheet&#x27;</span>;</span><br><span class=\"line\">  stylesheet.<span class=\"property\">type</span> = <span class=\"string\">&#x27;text/css&#x27;</span>;</span><br><span class=\"line\">  stylesheet.<span class=\"property\">href</span> = url;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (id) &#123; stylesheet.<span class=\"title function_\">setAttribute</span>(<span class=\"string\">&quot;id&quot;</span>, id); &#125;</span><br><span class=\"line\">  <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementsByTagName</span>(<span class=\"string\">&#x27;head&#x27;</span>)[<span class=\"number\">0</span>].<span class=\"title function_\">appendChild</span>(stylesheet);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">addStylesheet</span>(<span class=\"string\">&quot;Build/vendor.css&quot;</span>);</span><br><span class=\"line\"><span class=\"title function_\">addStylesheet</span>(<span class=\"string\">&quot;Build/custom.css&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Consider-the-environment\"><a href=\"#Consider-the-environment\" class=\"headerlink\" title=\"Consider the environment\"></a>Consider the environment</h2><p>Now everything was set up to implement a switch, depending on whether the SPA was started locally or in production.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> _DEV = (<span class=\"variable language_\">window</span>.<span class=\"property\">location</span>.<span class=\"property\">hostname</span>.<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;localhost&quot;</span>) !== -<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">addStylesheet</span>(<span class=\"string\">&quot;Build/vendor.css&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (_DEV) &#123;</span><br><span class=\"line\">  <span class=\"title function_\">addStylesheet</span>(<span class=\"string\">&quot;Libraries/styles.css&quot;</span>);</span><br><span class=\"line\">  <span class=\"title function_\">addStylesheet</span>(<span class=\"string\">&quot;Libraries/helpers.css&quot;</span>);</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">addStylesheet</span>(<span class=\"string\">&quot;Build/custom.css&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">addScriptAsync</span>(<span class=\"string\">&quot;Build/vendor.min.js&quot;</span>).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_DEV) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">addScriptAsync</span>(<span class=\"string\">&quot;Libraries/prototypes.js&quot;</span>)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123; <span class=\"keyword\">return</span> <span class=\"title function_\">addScriptAsync</span>(<span class=\"string\">&quot;Libraries/tools.js&quot;</span>); &#125;)</span><br><span class=\"line\">      .<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123; <span class=\"keyword\">return</span> <span class=\"title function_\">addScriptAsync</span>(<span class=\"string\">&quot;Libraries/app.js&quot;</span>); &#125;)</span><br><span class=\"line\">      ...</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">addScriptAsync</span>(<span class=\"string\">&quot;Build/custom.min.js&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","_path":"post/Implement-source-switch-for-SPA/","_link":"https://kiko.io/post/Implement-source-switch-for-SPA/","_id":"cljel57ts000qhqozg4ofd865"}}