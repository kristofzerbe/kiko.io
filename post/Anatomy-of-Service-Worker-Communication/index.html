<!DOCTYPE html>
<html lang="en">
<head><link rel=manifest href=/site.webmanifest>
  <meta charset="utf-8">
  
  
  <!-- POST -->

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>kiko.io | Anatomy of Service Worker Communication</title>
  <meta name="title" content="kiko.io | Anatomy of Service Worker Communication">
  <meta name="description" content="kiko.io&#39;s Post &#39;Anatomy of Service Worker Communication&#39;">
  <!-- Schema.org for Google -->
  <meta itemprop="name" content="kiko.io | Anatomy of Service Worker Communication">
  <meta itemprop="description" content="kiko.io&#39;s Post &#39;Anatomy of Service Worker Communication&#39;">
  <meta itemprop="image" content="https://kiko.io/images/social-media/Anatomy-of-Service-Worker-Communication.png">
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://kiko.io/post/Anatomy-of-Service-Worker-Communication/index.html">
  <meta property="og:title" content="kiko.io | Anatomy of Service Worker Communication">
  <meta property="og:description" content="kiko.io&#39;s Post &#39;Anatomy of Service Worker Communication&#39;">
  <meta property="og:image" content="https://kiko.io/images/social-media/Anatomy-of-Service-Worker-Communication.png">
  <meta property="og:locale" content="en_GB">

  <link rel="canonical" href="https://kiko.io/post/Anatomy-of-Service-Worker-Communication/index.html">

  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <meta name="theme-color" content="#444">

  <!-- webmention.io -->
  <link rel="webmention" href="https://webmention.io/kiko.io/webmention" />
  <link rel="pingback" href="https://webmention.io/kiko.io/xmlrpc" />

  <!-- IndieAuth -->
  <link rel="authorization_endpoint" href="https://indieauth.com/auth" />
  <link rel="token_endpoint" href="https://tokens.indieauth.com/token" />
  
  <!-- Feed -->
  

  <link rel="preload" href="/css/fonts/cookie/cookie-v12-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-italic.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-semibold.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-semibolditalic.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-Regular.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-It.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-Bold.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-BoldIt.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/fontawesome/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/fontawesome/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/fontawesome/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>

  <link rel="preload" as="image" href="/images/hero.jpg" imagesrcset="/images/hero-mobile.jpg 480w, /images/hero-tablet.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$404.jpg" imagesrcset="/photos/mobile/$404.jpg 480w, /photos/tablet/$404.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$about.jpg" imagesrcset="/photos/mobile/$about.jpg 480w, /photos/tablet/$about.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$photos.jpg" imagesrcset="/photos/mobile/$photos.jpg 480w, /photos/tablet/$photos.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$projects.jpg" imagesrcset="/photos/mobile/$projects.jpg 480w, /photos/tablet/$projects.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$tiny-tools.jpg" imagesrcset="/photos/mobile/$tiny-tools.jpg 480w, /photos/tablet/$tiny-tools.jpg 768w">

  <!-- TODO: dynamic from 2021 to year of today -->
  <link rel="preload" as="image" href="/photos/normal/$notes-2021.jpg" imagesrcset="/photos/mobile/$notes-2021.jpg 480w, /photos/tablet/$notes-2021.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$notes-2022.jpg" imagesrcset="/photos/mobile/$notes-2022.jpg 480w, /photos/tablet/$notes-2022.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$notes-2023.jpg" imagesrcset="/photos/mobile/$notes-2023.jpg 480w, /photos/tablet/$notes-2023.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$notes-2024.jpg" imagesrcset="/photos/mobile/$notes-2024.jpg 480w, /photos/tablet/$notes-2024.jpg 768w">

  
<link rel="stylesheet" href="/css/dist/bundle.min.css">

  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/tools.js"></script>

  
<script src="/js/dist/scroll-timeline.js"></script>

  
<script src="/js/dist/image-compare-viewer.min.js"></script>

  
<script src="/js/dist/tiny-slider.min.js"></script>



  <script defer type="text/javascript" 
    src="https://api.pirsch.io/pirsch.js"
    id="pirschjs"
    data-code="aJ835msd85Jl5WkTLtS76XLxVxSm4ODZ"></script>
  <script type="text/javascript" 
    src="https://api.pirsch.io/pirsch-events.js"
    id="pirscheventsjs"
    data-code="aJ835msd85Jl5WkTLtS76XLxVxSm4ODZ"></script>    


<meta name="generator" content="Hexo 6.3.0"></head>

<body id="body">  
  <div id="container" class="container">
    <div class="inner-container">
      <div id="wrap">
        <header id="header">
  <a href="#" id="header-photo-link" target="_blank" rel="noopener" ></a>
  <div id="banner">
    <div id="header-nav-start"></div>
    <nav id="header-nav" role="navigation">
      <ul class="menu">
        
          <li class="menu-item" id="nav-home-link" >
            <a class="nav-icon sub-nav-link"
              href="/">
                <span>Home</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-archives-link" >
            <a class="nav-icon sub-nav-link"
              href="/archives">
                <span>Archives</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-series-link" >
            <a class="nav-icon sub-nav-link"
              href="/series">
                <span>series</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-notes-link" >
            <a class="nav-icon sub-nav-link"
              href="/notes">
                <span>notes</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-projects-link" >
            <a class="nav-icon sub-nav-link"
              href="/projects">
                <span>projects</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-tiny-tools-link" >
            <a class="nav-icon sub-nav-link"
              href="/collections/tiny-tools">
                <span>tiny-tools</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-photos-link" >
            <a class="nav-icon sub-nav-link"
              href="/photos">
                <span>photos</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-about-link" >
            <a class="nav-icon sub-nav-link"
              href="/about">
                <span>About</span>
              </a>
          </li>
        
          <li class="menu-item" id="nav-rss-link" >
            <a class="nav-icon sub-nav-link"
              href="/atom.xml">
                <span>RSS Feed</span>
              </a>
          </li>
        
      </ul>
    </nav>
    <div id="header-nav-end"></div>
  </div>
  <div id="progress"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
        <a href="/" id="logo">
          <h1 id="title-wrap">
            <span style="opacity:0.2;">kiko.io</span>
          </h1>
        </a>
      
        <h2 id="subtitle">
          Memorable Tech Stuff
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        <a id="sub-nav-search" class="sub-nav-icon" title="Search"></a>
        <div id="sub-nav-theme">          
          <input type="checkbox" id="theme-switch">
          <label for="theme-switch"></label>
        </div>
      </nav>

      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://kiko.io"></form>
      </div>
    </div>
  </div>
</header>
<script>
  if (location.pathname === "/") {
    document.getElementById("nav-home-link").remove();
  }
</script>
        <div id="content" class="outer">
          <main>
  <style>
#banner {
    background-size: cover;
}
@media screen and (max-width: 479px) {
    #banner { background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 75%), url("/photos/mobile/22-05 Malta-8654.jpg"); }
}
@media screen and (min-width: 480px) and (max-width: 767px) {
    #banner { background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 75%), url("/photos/tablet/22-05 Malta-8654.jpg"); }
}
@media screen and (min-width: 768px) {
    #banner { background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 75%), url("/photos/normal/22-05 Malta-8654.jpg"); }    
}
</style>


    <img id="header-photo" src="/photos/normal/22-05 Malta-8654.jpg" width="0" height="0"/>
    <script>
        var header = document.getElementById("header");
        header.classList.add("photograph");
        
        var photoLink = document.getElementById("header-photo-link");
        photoLink.href = "https://500px.com/photo/1049918236/Rocky-Stairway-by-Kristof-Zerbe/";
        photoLink.innerHTML = "see <strong>Rocky Stairway</strong> at 500px";
    </script>




<script>
  var body = document.getElementById("body");
  body.classList.add("article-view");
</script>
  
<article id="post-2022/Anatomy-of-Service-Worker-Communication" 
         class="article article-type-post h-entry" itemscope itemprop="blogPost">
  
  <div class="article-meta">
    <div class="h-card p-author" style="display:none">
      <img class="u-photo" src="https://kiko.io/images/kristof-zerbe.png" alt="Kristof Zerbe" />
      <a class="p-name u-url" href="https://kiko.io" rel="author">Kristof Zerbe</a>
    </div>
    <a class="u-url u-uid" href="https://kiko.io/post/Anatomy-of-Service-Worker-Communication/" style="display:none;">https://kiko.io/post/Anatomy-of-Service-Worker-Communication/</a>
    <a href="/post/Anatomy-of-Service-Worker-Communication/" class="article-date">
  
    <time class="published dt-published" datetime="2022-11-12T11:26:34.000Z" itemprop="datePublished">12 Nov 2022</time>
  
</a>
    
  <div class="article-category p-category category-javascript">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a> 
  </div>

  </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        




        
  
    <h1 class="article-title p-name" itemprop="name">
      Anatomy of Service Worker Communication
    </h1>
  

        
    <h2 class="article-subtitle p-summary" itemprop="name">
        Let your App communicate with its Service Worker
    </h2>

      </header>
    
    
    <div class="article-entry e-content" itemprop="articleBody">
      <p>I have a SPA that works as a PWA, which means that in the background a service worker makes sure that the required files for the offline mode end up in the cache.</p>
<p>From time to time I also update the Service Worker, which defines which files it should keep offline and which not. Unfortunately, the app itself didn’t get any of this because there was no communication channel for them to talk.</p>
<p>If you research this topic on the web, you have to dig through many architecture pages and documentations that have one thing in common: sometimes they just don’t get to the point. So here are my 50 cents on the subject and my sample implementation.</p>
<span id="more"></span>

<h2 id="Preliminary-Thoughts"><a href="#Preliminary-Thoughts" class="headerlink" title="Preliminary Thoughts"></a>Preliminary Thoughts</h2><p>In most examples I’ve read, the authors talk about code for the app itself and code for the Service Worker, but that falls short to me, because in my opinion there are THREE parts:</p>
<ol>
<li>The <strong>App</strong></li>
<li>The <strong>Service Worker</strong></li>
<li>The <strong>Service Worker Management</strong>, which takes care of the proper registration and installation of the service worker</li>
</ol>
<p>The last part of the code shouldn’t be part of the app itself, in the meaning of SoC (Seperation of Concerns). It does not contribute to the functioning of the app.</p>
<hr>
<h2 id="The-App"><a href="#The-App" class="headerlink" title="The App"></a>The App</h2><p>Here’s the general anatomy of my App:</p>
<figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = &#123;</span><br><span class="line">  <span class="string">&#x27;settings&#x27;</span>: &#123; <span class="comment">// some stuff on app settings</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;pages&#x27;</span>: &#123; <span class="comment">// views of the SPA</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;ui&#x27;</span>: &#123; <span class="comment">// some UI helper</span></span><br><span class="line">    <span class="string">&#x27;dialog&#x27;</span>: <span class="keyword">function</span>(<span class="params">msg, title</span>) &#123;</span><br><span class="line">      <span class="comment">// show the message in a toast, popup or elsewhere</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;starter&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;init&#x27;</span>: &#123; <span class="comment">// initializing of the app</span></span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">app</span> = app;</span><br><span class="line">app.<span class="property">starter</span>.<span class="title function_">init</span>();</span><br></pre></td></tr></table></figure>

<p>Nothing unlikely, as I guess. It is built according to the composite pattern and has one entry point, that is called at the end of the file after it is instantiated.</p>
<hr>
<h2 id="The-Service-Worker"><a href="#The-Service-Worker" class="headerlink" title="The Service Worker"></a>The Service Worker</h2><p>The Service Worker lives in its own JS file and its implementation is really straight forward:</p>
<figure class="highlight js"><figcaption><span>service-worker.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cacheName = <span class="string">&#x27;my-apps-cache-v1.2.3&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> appFiles = [</span><br><span class="line">  <span class="comment">// list of app relating files, that has to be handled</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> excludeUrls = [ </span><br><span class="line">  <span class="comment">// list if URL&#x27;s that shouldn&#x27;t be handled</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;install&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="comment">// on install, open the cache and add all appFiles</span></span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//activate immediatly and dont wait for connected clients to disconnect</span></span><br><span class="line">  self.<span class="title function_">skipWaiting</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;activate&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="comment">// remove old caches</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//say to all clients: Now I&#x27;m responsible</span></span><br><span class="line">  self.<span class="property">clients</span>.<span class="title function_">claim</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="comment">// intercept requests and serve the app files out of the cache</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I won’t go into the depth of my implementation here now, since it doesn’t matter for the message exchange. It is only good for you to know that I have versioned the cache name to exchange it with new versions.</p>
<hr>
<h2 id="The-Service-Worker-Management"><a href="#The-Service-Worker-Management" class="headerlink" title="The Service Worker Management"></a>The Service Worker Management</h2><p>Now the management code for the Service Worker. It has to be loaded with the app code, because it is client code and later on it needs knowledge of the app.</p>
<figure class="highlight js"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line"></span><br><span class="line">  navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">&#x27;service-worker.js&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">registration</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// detect Service Worker update available</span></span><br><span class="line">      registration.<span class="title function_">addEventListener</span>(<span class="string">&#x27;updatefound&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (registration.<span class="property">installing</span>) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// detect install of new Service Worker</span></span><br><span class="line">          registration.<span class="property">installing</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;statechange&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (registration.<span class="property">waiting</span>) &#123;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>) &#123;</span><br><span class="line">                <span class="comment">// there is an existing controller that has been updated</span></span><br><span class="line">                <span class="comment">//<span class="doctag">TODO:</span> Send a message to the app</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// first install</span></span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Lets-Communicate…"><a href="#Lets-Communicate…" class="headerlink" title="Lets Communicate…"></a>Lets Communicate…</h2><p>In this setup, the communication code can be implemented. Let’s do it as a round trip.</p>
<h3 id="1-Client-sends-message-to-Service-Worker"><a href="#1-Client-sends-message-to-Service-Worker" class="headerlink" title="1. Client sends message to Service Worker"></a>1. Client sends message to Service Worker</h3><p>As <code>sw-management.js</code> represents our Service Worker management code, we add a little function to send a message in here:</p>
<figure class="highlight js"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sendMessageToServiceWorker</span>(<span class="params">type, msg</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>) &#123;</span><br><span class="line">      navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>.<span class="title function_">postMessage</span>(</span><br><span class="line">        &#123;<span class="string">&#x27;type&#x27;</span>: type, <span class="string">&#x27;msg&#x27;</span>: msg &#125;</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We define a type for the purpose of our communcation and a message itself. The function can be called wherever, like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">sendMessageToServiceWorker</span>(<span class="string">&quot;TEST&quot;</span>, <span class="string">&quot;Hey, Service Worker&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-Service-Worker-receives-the-message"><a href="#2-Service-Worker-receives-the-message" class="headerlink" title="2. Service Worker receives the message"></a>2. Service Worker receives the message</h3><p>In the Service Worker code we need to add a recipient:</p>
<figure class="highlight js"><figcaption><span>service-worker.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123; </span><br><span class="line">  <span class="keyword">if</span> (!event.<span class="property">data</span>) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">data</span>.<span class="property">type</span> === <span class="string">&#x27;TEST&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// do something regarding to the type and/or with the message</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-…-and-sends-a-message-back-to-the-client"><a href="#3-…-and-sends-a-message-back-to-the-client" class="headerlink" title="3. … and sends a message back to the client"></a>3. … and sends a message back to the client</h3><p>What we want to do with the message depends what we want to achive, but in this example, just let’s greet back:</p>
<figure class="highlight js"><figcaption><span>service-worker.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sendMessageToClients</span>(<span class="params">type, msg</span>) &#123;</span><br><span class="line">  <span class="comment">// as the SW can control multiple clients, we have to catch them all</span></span><br><span class="line">  self.<span class="property">clients</span>.<span class="title function_">matchAll</span>(&#123; <span class="attr">includeUncontrolled</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">clients</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">const</span> client <span class="keyword">of</span> clients) &#123;</span><br><span class="line">              client.<span class="title function_">postMessage</span>(</span><br><span class="line">                &#123;<span class="string">&#x27;type&#x27;</span>: type, <span class="string">&#x27;msg&#x27;</span>: msg &#125;</span><br><span class="line">              );</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123; </span><br><span class="line">  <span class="keyword">if</span> (!event.<span class="property">data</span>) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">data</span>.<span class="property">type</span> === <span class="string">&#x27;TEST&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">sendMessageToClients</span>(event.<span class="property">data</span>.<span class="property">type</span>, <span class="string">&#x27;Hi Clients...&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Client-receives-the-answer-from-the-Service-Worker"><a href="#4-Client-receives-the-answer-from-the-Service-Worker" class="headerlink" title="4. Client receives the answer from the Service Worker"></a>4. Client receives the answer from the Service Worker</h3><p>In order to get messages from the Service Worker, we have to implement a receiver in the client also:</p>
<figure class="highlight js"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//... &#x27;navigator.serviceWorker.register&#x27; stuff</span></span><br><span class="line"></span><br><span class="line">  navigator.<span class="property">serviceWorker</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">data</span>) &#123;</span><br><span class="line">        <span class="comment">// do something with the message from the Service Worker</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-…-and-shows-it-in-the-app"><a href="#5-…-and-shows-it-in-the-app" class="headerlink" title="5. … and shows it in the app"></a>5. … and shows it in the app</h3><p>As I pointed out earlier, that the management code has to be loaded alongside with the app code, it’s a breeze to show the message:</p>
<figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="string">&#x27;ui&#x27;</span>: &#123; <span class="comment">// some UI helper</span></span><br><span class="line">    <span class="string">&#x27;dialog&#x27;</span>: <span class="keyword">function</span>(<span class="params">msg, title</span>) &#123;</span><br><span class="line">      <span class="comment">// show the message in a toast, popup or elsewhere</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">app</span> = app;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//... &#x27;navigator.serviceWorker.register&#x27; stuff</span></span><br><span class="line"></span><br><span class="line">  navigator.<span class="property">serviceWorker</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">data</span>) &#123;</span><br><span class="line">        app.<span class="property">ui</span>.<span class="property">dialog</span>.<span class="title function_">info</span>(event.<span class="property">data</span>.<span class="property">msg</span>, <span class="string">&#x27;Service Worker says...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="The-Update-Message"><a href="#The-Update-Message" class="headerlink" title="The Update Message"></a>The Update Message</h2><p>With this infrastructure, everything is there to show a message, when the Service Worker is updated:</p>
<figure class="highlight js"><figcaption><span>sw-management.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line"></span><br><span class="line">  navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">&#x27;service-worker.js&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">registration</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// detect Service Worker update available</span></span><br><span class="line">      registration.<span class="title function_">addEventListener</span>(<span class="string">&#x27;updatefound&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (registration.<span class="property">installing</span>) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// detect install of new Service Worker</span></span><br><span class="line">          registration.<span class="property">installing</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;statechange&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (registration.<span class="property">waiting</span>) &#123;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>) &#123;</span><br><span class="line">                <span class="comment">// there is an existing controller that has been updated</span></span><br><span class="line"></span><br><span class="line">                app.<span class="property">ui</span>.<span class="property">dialog</span>.<span class="title function_">info</span>(<span class="string">&#x27;New version installed&#x27;</span>, <span class="string">&#x27;Service Worker&#x27;</span>);</span><br><span class="line"></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// first install</span></span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Important to point out, that the Service Worker side of the communication is not involved in this case, because only the client-side management code knows when a new version has to be installed.</p>
<hr>
<h2 id="More-Info"><a href="#More-Info" class="headerlink" title="More Info"></a>More Info</h2>
        <ul class="moreinfo-list">
            <li>Jake Archibald: <a href="https://web.dev/service-worker-lifecycle/">The service worker lifecycle</a></li><li>Demian Renzulli & Andrew Guan: <a href="https://web.dev/two-way-communication-guide/">Two-way communication with service workers</a></li><li>Adam Bar: <a href="https://whatwebcando.today/articles/handling-service-worker-updates">Handling Service Worker updates – how to keep the app updated and stay sane</a></li><li>Felix Gerschau: <a href="https://www.peterkroener.de/postmessage-zwischen-service-worker-und-clients/">Service Worker Lifecycle Explained</a></li><li>Felix Gerschau: <a href="https://felixgerschau.com/how-to-communicate-with-service-workers/">How to communicate with Service Workers</a></li><li>Peter Kröner: <a href="https://www.peterkroener.de/postmessage-zwischen-service-worker-und-clients/">PostMessage zwischen Service Worker und Client(s) (GERMAN)</a></li>
        </ul>
    

    </div>
    
    <footer class="article-footer">      
      
  <div class="article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PWA/" rel="tag">PWA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPA/" rel="tag">SPA</a></li></ul>  
  </div>

      
  <div class="article-syndication">
    <span>Syndicated at</span> 
    
        <a class="syndication-link u-syndication fab fa-mastodon" 
           href="https://indieweb.social/@kiko/109337328502493774" rel="syndication" target="_blank"></a>
    
        <a class="syndication-link u-syndication fab fa-twitter" 
           href="https://twitter.com/kristofz/status/1591765769284878339" rel="syndication" target="_blank"></a>
    
  </div>

      <div class="article-permalink" id="article-permalink-clckokv3i0027miomhfyo2qdh">
    <input class="article-permalink-value" value="https://kiko.io/post/Anatomy-of-Service-Worker-Communication/" 
           data-id="clckokv3i0027miomhfyo2qdh" data-title="Anatomy of Service Worker Communication" />
    <a class="article-action action-copy"></a>
    <a class="article-action action-share"></a>
</div>
<script>
    window.addEventListener("load", () => {
        initPermalink("clckokv3i0027miomhfyo2qdh");
    });
</script>

      
    </footer>

  </div>

  
  <div class="article-webmentions">

  <h2>Webmentions</h2>

  <div class="webmentions-placeholder">
    <p class="wm-placeholder">No Webmentions yet...</p>
  </div>
  
  <p class="webmention-form-info">
    In case your blog software can't send Webmentions, 
    you can use this form to submit me a mention of this article...
  </p>
  
  <form class="webmention-form" action="https://webmention.io/kiko.io>/webmention" 
        name="webmention-form" method="post">
    <label for="webmention-form-source">Your Article URL:</label><br>
    <input class="webmention-form-source" type="url" name="source" 
           placeholder="https://your-blog.com/your-article" required="">
    <input type="hidden" name="target" value="https://kiko.io/post/Anatomy-of-Service-Worker-Communication/">
    <input type="submit" value="Send Webmention">
  </form>

  <script>
    window.addEventListener('load', function () {
      insertWebmentions('2022/anatomy-of-service-worker-communication', 'https://kiko.io', 'Kristof Zerbe');
    });
  </script>

  

</div>
  <div class="article-comments">
  <h2>Comments</h2>
  <div id="comment-placeholder"></div>
  <script>
    window.addEventListener('load', function () {
      insertUtterancesCommentBlock();
    });
  </script>
</div>
  
  <div class="article-related">
    <h2>Related</h2>
    <div class="archives">
      
        
        <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      
    <a href="/post/Application-Specific-Links-on-Windows-10/">
        <img class="archive-article-photo" src="/photos/tablet/D70_0247.jpg" alt="Copenhagen Window" />
    </a>

    </header>
    <div class="archive-article-content">
      <a href="/post/Application-Specific-Links-on-Windows-10/" class="archive-article-date">
  
    <time class="published dt-published" datetime="2021-09-03T07:31:08.000Z" itemprop="datePublished">03 Sep 2021</time>
  
</a>
      
  <div class="archive-article-category category-misc">
    <a class="article-category-link" href="/categories/Misc/">Misc</a> 
  </div>

      




      
  
    <h1 itemprop="name">
      <a class="archive-article-title" href="/post/Application-Specific-Links-on-Windows-10/">Application-Specific Links on Windows 10</a>
    </h1>
  

      
    <h2 class="archive-article-subtitle" itemprop="name">
        What works and what we still have to wait for
    </h2>
              
    </div>
    <div class="archive-article-footer">
      
  <div class="archive-article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Browser/" rel="tag">Browser</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PWA/" rel="tag">PWA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/" rel="tag">Windows</a></li></ul>  
  </div>

    </div>
</div>
</article>
        
      
        
        <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      
    <a href="/post/Implement-source-switch-for-SPA/">
        <img class="archive-article-photo" src="/photos/tablet/DSC_6063.jpg" alt="Illuminated Chair" />
    </a>

    </header>
    <div class="archive-article-content">
      <a href="/post/Implement-source-switch-for-SPA/" class="archive-article-date">
  
    <time class="published dt-published" datetime="2020-10-04T15:01:02.000Z" itemprop="datePublished">04 Oct 2020</time>
  
</a>
      
  <div class="archive-article-category category-javascript">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a> 
  </div>

      




      
  
    <h1 itemprop="name">
      <a class="archive-article-title" href="/post/Implement-source-switch-for-SPA/">Implement source switch for SPA</a>
    </h1>
  

      
    <h2 class="archive-article-subtitle" itemprop="name">
        Asynchronous loading of JS and CSS depending on the environment
    </h2>
              
    </div>
    <div class="archive-article-footer">
      
  <div class="archive-article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Bundling/" rel="tag">Bundling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPA/" rel="tag">SPA</a></li></ul>  
  </div>

    </div>
</div>
</article>
        
      
        
        <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      
    <a href="/post/Native-JavaScript-Multilanguage-Templating/">
        <img class="archive-article-photo" src="/photos/tablet/DSC_6682.jpg" alt="Blue Lock" />
    </a>

    </header>
    <div class="archive-article-content">
      <a href="/post/Native-JavaScript-Multilanguage-Templating/" class="archive-article-date">
  
    <time class="published dt-published" datetime="2021-02-24T12:31:58.000Z" itemprop="datePublished">24 Feb 2021</time>
  
</a>
      
  <div class="archive-article-category category-javascript">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a> 
  </div>

      




      
  
    <h1 itemprop="name">
      <a class="archive-article-title" href="/post/Native-JavaScript-Multilanguage-Templating/">Native JavaScript Multilanguage Templating</a>
    </h1>
  

                    
    </div>
    <div class="archive-article-footer">
      
  <div class="archive-article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6/" rel="tag">ES6</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Localization/" rel="tag">Localization</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Templating/" rel="tag">Templating</a></li></ul>  
  </div>

    </div>
</div>
</article>
        
      
    </div>
  </div>

  
<nav id="article-nav">
  
    <a href="/post/Syndicate-Mastodon-Hashtags-in-your-favorite-Feed-Reader/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Syndicate Mastodon Hashtags in your favorite Feed Reader
        
      </div>
    </a>
  
  
    <a href="/post/Discoveries-20-CSS-UI/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Discoveries #20 - CSS &amp; UI</div>
    </a>
  
</nav>

  

</article></main>
          
            <aside id="sidebar">
  
    <div class="widget-wrap">
    <div class="widget about h-card"><!--http://microformats.org/wiki/h-card-->
        <div class="avatar">
            <a href="/about"><img class="u-photo" src="https://kiko.io/images/kristof-zerbe.png" alt="Kristof Zerbe"></a>
            <a href="https://github.com/kristofzerbe" target="_blank" class="fab fa-github" rel="me"></a>
            <a href="https://www.xing.com/profile/Kristof_Zerbe" target="_blank" class="fab fa-xing" rel="me"></a>
            <a href="https://www.linkedin.com/in/kristof-zerbe-91012510/" target="_blank" class="fab fa-linkedin" rel="me"></a>      
            <a href="https://500px.com/kikon" target="_blank" class="fab fa-500px" rel="me"></a>
            <a href="https://indieweb.social/@kiko" target="_blank" class="fab fa-mastodon" rel="me"></a>
        </div>
        <h3 class="p-name">Kristof Zerbe</h3>
        <p class="p-note">
            <i class="p-role">Developer and Team Lead</i> located in <i class="p-locality">Wiesbaden</i>, <i class="p-country-name">Germany</i>
        </p>
        <a class="u-url u-uid" href="https://kiko.io" style="display:none;"></a>
    </div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            
              <a href="/post/Discoveries-22-Tips-Tricks/">Discoveries #22 -  Tips/Tricks</a>
            
          </li>
        
          <li>
            
              <a href="/post/Generate-Content-from-Trello/">Generate Content from Trello</a>
            
          </li>
        
          <li>
            
              <a href="/post/Discoveries-21-Sites-Pages/">Discoveries #21 -  Sites &amp; Pages</a>
            
          </li>
        
          <li>
            
              <a href="/post/The-State-of-the-Blog/">The State of the Blog</a>
            
          </li>
        
      </ul>
    </div>
  </div>

  

  <div class="widget widget-wrap">
    <p>
      Want more? This way ... to the <a href="/archives">archives</a>
    </p>
  </div>  
</aside>
          
        </div>
        <footer id="footer">
  
  <div class="outer">
    <div class="inner">
        <div id="footer-info" class="footer-block">
          &copy; 2023 <a href="https://bio.link/kristof">Kristof Zerbe</a><br>
          Powered by <a href="https://hexo.io/">Hexo</a> & <a href="https://github.com/">GitHub</a>  
        </div>
        <ul id="footer-menu" class="footer-block">
          
            <li class="menu-item" id="menu-about-link">
              <a href="/about">
                  <span>About</span>
                </a>
            </li>
          
            <li class="menu-item" id="menu-rss-link">
              <a href="/atom.xml">
                  <span>RSS Feed</span>
                </a>
            </li>
          
        </ul>
        
        <div id="footer-bmc" class="footer-block">
          <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" 
                  data-name="bmc-button" data-slug="kikoio" 
                  data-font="Cookie" data-text="Buy me a coffee" data-emoji="" 
                  data-color="#55555" data-outline-color="#fff" data-font-color="#fff" data-coffee-color="#fd0" ></script>
        </div>
        
        <ul id="footer-dots">
          <li class="dot"><a href="https://search.google.com/search-console?resource_id=sc-domain%3Akiko.io" title="SearchConsole"></a></li>
          <li class="dot"><a href="https://kiko-io.pirsch.io/" title="Pirsch"></a></li>
          <li class="dot"><a href="https://webmentions.kiko.io" title="Webmention Analytics"></a></li>
        </ul>
        <div id="webring">
          <a id="webring-prev" href="https://xn--sr8hvo.ws/%F0%9F%A7%80%F0%9F%91%9F%F0%9F%8E%8A/previous">←</a>
          <a href="https://xn--sr8hvo.ws">IndieWeb Webring</a> 🕸💍
          <a id="webring-next" href="https://xn--sr8hvo.ws/%F0%9F%A7%80%F0%9F%91%9F%F0%9F%8E%8A/next">→</a>
        </div>      
    </div>
  </div>
</footer>
      </div>
      <script>
  let isOffline = 'false' === 'true';
</script>


<script src="/js/jquery-3.6.0.min.js"></script>


<script src="/js/dist/bundle.min.js"></script>


<script src="/js/script.js"></script>


<script>
  // HEADER
  var header = {
    height: 0,
    top: 0,
    offset: 55,
    photoLinkOpacity: 0,
    titleFontSize: 0
  };

  function initHeader() {
    $("#header").css("height", ""); //reset inline css
    $("#header-title").css("top", "");
    $("#header-photo-link").css("opacity", "");
    $("#title-wrap").css("font-size", "");
    header.height = $("#header").height(); //set from given css
    header.top = parseFloat($("#header-title").css("top"));
    header.photoLinkOpacity = parseFloat($("#header-photo-link").css("opacity"));
    header.titleFontSize = parseFloat($("#title-wrap").css("font-size"));
    scrollHeader();
  }
  function scrollHeader() {
    var h = header.height - header.offset,
        st = $(document).scrollTop(),  
        d = (h - st),
        p = (d / h),
        hfs = header.titleFontSize / 5 * 3,
        jSide = $("aside");
    if (d > 0) {
      $("#header").css("height", d + header.offset + "px");
      $("#header-photo-link").css("opacity", header.photoLinkOpacity * p);
      $("#banner").css("opacity", p);
      $("#title-wrap").css("font-size", header.titleFontSize - ( header.titleFontSize / 3) * (1 - p) );
      $("#header-title").css("top", header.top - (hfs * (1 - p)) + "px");
      $("#subtitle").css("opacity", p);
      jSide.css("max-width", "").css("position", "").css("top", "");
    } else {
      $("#header").css("height", header.offset + "px");
      $("#header-photo-link").css("opacity", 0);
      $("#banner").css("opacity", 0);
      $("#title-wrap").css("font-size", header.titleFontSize - ( header.titleFontSize / 3) * (1) );      
      $("#header-title").css("top", header.top - (hfs * (1)) + "px");      
      $("#subtitle").css("opacity", 0);
      if (window.matchMedia("screen and (min-width: 768px)").matches & window.innerHeight > (jSide.height() + 50)) {
        jSide.css("max-width", $("aside").width()).css("position", "fixed").css("top", "50px");
      }
    }    
  }

  // IMAGE VIEWPORT
  function isVisibleInViewPort(e) {
    var viewTop = $(window).scrollTop();
    var viewBottom = viewTop + $(window).height();
  
    var eTop = $(e).offset().top;
    var eBottom = eTop + $(e).height();
  
    return ((eBottom <= viewBottom) && (eTop >= viewTop));
  }
  function initViewportImage() {
    $(".article-photo, .archive-article-photo, .card-img, .img-link").each(function() {
      if (isVisibleInViewPort($(this))) {
        $(this).addClass("in-view");
      } else {
        $(this).removeClass("in-view");
      }
    });
  }

  // HORIZONTAL MENU SCROLL
  function watchNavMenuScroll() {
    const nav = document.querySelector('#header-nav');
    const menu = nav.querySelector('.menu');
    const firstMenuItem = menu.querySelector('.menu-item:first-child');
    const lastMenuItem = menu.querySelector('.menu-item:last-child');

    firstMenuItem.setAttribute("data-scim", "start");
    lastMenuItem.setAttribute("data-scim", "end");
    
    let observer = new IntersectionObserver((entries, observer) => { 
      entries.forEach(entry => {

        let scimElement = document.querySelector("#header-nav-" + entry.target.getAttribute("data-scim"));
        if (entry.intersectionRatio != 1) { 
          scimElement.classList.add("show");
        } else {
          scimElement.classList.remove("show");
        }
      });
    }, {threshold: 1});
    
    observer.observe(firstMenuItem);
    observer.observe(lastMenuItem);
  }

  $(window).on('scroll', function() {
    scrollHeader();
    initViewportImage();
  });

  $(window).on('resize', function() {
    initHeader();
    initViewportImage();
  });

  initHeader();
  initViewportImage();
  watchNavMenuScroll();

  // BACK-TO-TOP
  addBackToTop({
    diameter: 30
  })

  // AUTOTYPING
  setTimeout(function() {
    $("#title-wrap").empty();
    new AutoTyping({
      id: 'title-wrap',
      typeText: ['kiko.io'],
      textColor: '#fff',
      typeSpeed: 100,
      typeDelay: 100,
      showCursor: false,
      delete: false,
      typeInfinity: false
    }).init();
  }, 1000);

  //MEDIUM-ZOOM
  mediumZoom(document.querySelectorAll('img.zoom'), {
    background: 'rgba(55, 55, 55, 0.5)',
    margin: 20
  });

  //SCROLL-TIMELINE
  // Create ScrollTimeline
  const myScrollTimeline = new ScrollTimeline({
    source: document.scrollingElement,
    scrollSource: document.scrollingElement, // For legacy implementations
    orientation: 'block',
      scrollOffsets: [
          new CSSUnitValue(0, 'percent'),
          new CSSUnitValue(100, 'percent'),
      ],
  });

  // Animate Progress Bar on Scroll
  document.querySelector("#progress").animate(
    {
      transform: ["scaleX(0)", "scaleX(1)"]
    },
    { 
      duration: 1, 
      fill: "forwards", 
      timeline: myScrollTimeline 
    }
  );
</script>


  <script>
    //HOOK LINKS FOR PIRSCH EVENT...

    //BUY ME A COFFEE
    let bmc = document.querySelector(".bmc-btn");
    if (bmc) bmc.addEventListener("click", function() { pirsch('Buy Me A Coffee clicked') });

    //FEED
    let feed = document.querySelector("#nav-rss-link a.sub-nav-link");
    if (feed) feed.addEventListener("click", function() { pirsch('Feed clicked') });

    //VSCODE
    let vscode = document.querySelectorAll(".brand-links .vscode").forEach(link => link.addEventListener("click", function() { pirsch("Open in VSCode"); }));
  </script>  

    </div>
  </div>
</body>
</html>