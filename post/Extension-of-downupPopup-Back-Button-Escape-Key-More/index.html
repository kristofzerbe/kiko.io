<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title data-area="POST">Extension of downupPopup: Back Button, Escape Key &amp; More - kiko.io</title>
  <meta name="author" content="Kristof Zerbe">
  <meta name="title" content="Extension of downupPopup: Back Button, Escape Key &amp; More - kiko.io">
  
  <meta name="description" content="Contributing to Ali Dinçer&#39;s Bottom Sheet project">
  
   
  <meta name="excerpt" content="I recently introduced a Bottom Sheet dialog on this blog to display a page’s metadata (like this), using Ali Dincer’s work: downupPopup. I described the way to do this in a post a couple three weeks ago.
Shortly after that Koos Looijensteijn triggered me with his post How to make digital business cards and share them via QR codes and I felt like using my newly introduced dialog manager based on downupPopup for my own contact card.But more about that at a later time, respectively blog post…
Important for this post is that Ali’s bottom sheet solution did not offer everything I wanted for my implementation:
1. Make Dialog ReusableAs I have already described in the above mentioned article: Ali’s approach to calling the dialog was to create and initialize the necessary HTML elements if it didn’t already exist in the DOM. I pulled out the initialization to make the component reusable. There is now a preparation part and an initialization part and the latter is always called, no matter if another bottom sheet dialog was already created before.
My GitHub commit on this part…">
  
  
  <link rel="canonical" href="https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <meta name="theme-color" content="#444">

    
  <script type="application/ld+json">{"@context":"http://schema.org/","@graph":[{"@type":"Article","@id":"https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/#article","mainEntityOfPage":{"@id":"https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/"},"headline":"Extension of downupPopup: Back Button, Escape Key &amp; More - kiko.io","description":"Contributing to Ali Dinçer&#39;s Bottom Sheet project","datePublished":"2023-07-04T11:07:38Z","dateModified":"2023-07-04T11:07:38Z","image":{"@id":"https://kiko.io#image/Extension-of-downupPopup-Back-Button-Escape-Key-More"},"author":{"@id":"https://kiko.io/#person"},"publisher":{"@id":"https://kiko.io/#organization"}},{"@type":"WebPage","@id":"https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/","url":"https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/","name":"Extension of downupPopup: Back Button, Escape Key &amp; More - kiko.io","isPartOf":{"@id":"https://kiko.io/#website"},"description":"Contributing to Ali Dinçer&#39;s Bottom Sheet project","inLanguage":"en-US","primaryImageOfPage":{"@id":"https://kiko.io#image/Extension-of-downupPopup-Back-Button-Escape-Key-More"},"image":{"@id":"https://kiko.io#photo/D50_7484.jpg"}},{"@type":"WebSite","@id":"https://kiko.io/#website","url":"https://kiko.io","name":"kiko.io","description":"Blog about memorable tech stuff by Kristof Zerbe","inLanguage":"en-US","publisher":{"@id":"https://kiko.io/#organization"},"potentialAction":{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://kiko.io/search/?q={searchTerm}"},"query-input":"required name=searchTerm"}},{"@type":"Organization","@id":"https://kiko.io/#organization","name":"kiko.io","url":"https://kiko.io","logo":"https://kiko.io/images/icon-192x192.png"},{"@type":"Person","@id":"https://kiko.io/#person","name":"Kristof Zerbe","url":"https://kiko.io/about","image":"https://kiko.io/images/kristof-zerbe.png","sameAs":["https://github.com/kristofzerbe","https://www.xing.com/profile/Kristof_Zerbe","https://www.linkedin.com/in/kristof-zerbe-91012510/","https://500px.com/p/kikon","https://indieweb.social/@kiko","https://pixelfed.social/kristofz"]},{"@type":"ImageObject","@id":"https://kiko.io#photo/D50_7484.jpg","caption":"Garden Beauties XV","url":"https://kiko.io/photos/normal/D50_7484.jpg","contentUrl":"https://kiko.io/photos/normal/D50_7484.jpg","discussionUrl":"https://kiko.io/photos/D50_7484","license":"https://creativecommons.org/licenses/by-sa/4.0/","acquireLicensePage":"https://kiko.io/photos","creditText":"Kristof Zerbe","copyrightNotice":"Kristof Zerbe (CC BY-SA 4.0)","creator":{"@id":"https://kiko.io/#person"}},{"@type":"ImageObject","@id":"https://kiko.io#image/Extension-of-downupPopup-Back-Button-Escape-Key-More","url":"/images/social-media/Extension-of-downupPopup-Back-Button-Escape-Key-More.png","contentUrl":"/images/social-media/Extension-of-downupPopup-Back-Button-Escape-Key-More.png","license":"https://creativecommons.org/licenses/by-sa/4.0/","acquireLicensePage":"https://kiko.io/photos","creditText":"Kristof Zerbe","copyrightNotice":"Kristof Zerbe (CC BY-SA 4.0)","creator":{"@id":"https://kiko.io/#person"}}]}</script>

    <meta property="og:site_name" content="kiko.io">
  <meta property="og:type" content="blog">
  <meta property="og:url" content="https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/">
  <meta property="og:title" content="Extension of downupPopup: Back Button, Escape Key &amp; More - kiko.io">
  
  <meta property="og:description" content="Contributing to Ali Dinçer&#39;s Bottom Sheet project">
  
  <meta property="og:image" content="https://kiko.io/images/social-media/Extension-of-downupPopup-Back-Button-Escape-Key-More.png">
  <meta property="og:locale" content="en_US">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/">
  <meta property="twitter:title" content="Extension of downupPopup: Back Button, Escape Key &amp; More - kiko.io">
  
  <meta property="twitter:description" content="Contributing to Ali Dinçer&#39;s Bottom Sheet project">
  
  <meta property="twitter:image" content="https://kiko.io/images/social-media/Extension-of-downupPopup-Back-Button-Escape-Key-More.png">

    <link rel="webmention" href="https://webmention.io/kiko.io/webmention" />
  <link rel="pingback" href="https://webmention.io/kiko.io/xmlrpc" />

    <link rel="authorization_endpoint" href="https://indieauth.com/auth" />
  <link rel="token_endpoint" href="https://tokens.indieauth.com/token" />
  <link href="https://github.com/kristofzerbe" rel="me authn">
  <link href="mailto:kristof.zerbe@gmail.com" rel="me authn">
  
    <link rel="alternate" href="/atom.xml" title="Extension of downupPopup: Back Button, Escape Key &amp; More - kiko.io" type="application/atom+xml">

  <link rel="preload" href="/css/fonts/opensans/opensans-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-italic.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-semibold.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-semibolditalic.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-Regular.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-It.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-Bold.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-BoldIt.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/forkawesome/forkawesome-webfont.woff2" as="font" type="font/woff2" crossorigin>

  
  <link rel="preload" as="image" id="img-preload" href="/images/social-media/Extension-of-downupPopup-Back-Button-Escape-Key-More.png" 
        imagesrcset="/images/social-media/Extension-of-downupPopup-Back-Button-Escape-Key-More.png 480w, /images/social-media/Extension-of-downupPopup-Back-Button-Escape-Key-More.png 768w">
  <link rel="preload" as="image" id="photo-preload" href="/photos/normal/D50_7484.jpg" 
        imagesrcset="/photos/mobile/D50_7484.jpg 480w, /photos/tablet/D50_7484.jpg 768w">
  
    
  
<link rel="stylesheet" href="/css/dist/bundle.min.css">

  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/tools.js"></script>

  
<script src="/js/dialog.js"></script>

  
<script src="/js/dist/scroll-timeline.js"></script>

  
<script src="/js/dist/tiny-slider.min.js"></script>

  
<script src="/js/dist/image-compare-viewer.min.js"></script>

  
<script src="/js/dist/macy.js"></script>



  <script defer type="text/javascript" 
    src="https://api.pirsch.io/pirsch.js"
    id="pirschjs"
    data-code="aJ835msd85Jl5WkTLtS76XLxVxSm4ODZ"></script>
  <script type="text/javascript" 
    src="https://api.pirsch.io/pirsch-events.js"
    id="pirscheventsjs"
    data-code="aJ835msd85Jl5WkTLtS76XLxVxSm4ODZ"></script>    


<meta name="generator" content="Hexo 6.3.0"></head>

<body id="body">  
  <header id="header">
  <a href="#" id="header-photo-link" rel="noopener" ></a>
  <div id="banner">
    <div id="header-nav-start"></div>
    <nav id="header-nav" role="navigation">
      <ul class="menu">
        
          
          <li class="menu-item menu-item-icon" id="nav-home-link">
            <a class="sub-nav-link"
               href="/">
                <span>Home</span>
              </a>
          </li>
        
          
          <li class="menu-item menu-item-icon" id="nav-search-link">
            <a class="sub-nav-link"
               href="/search">
                <span>Search</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-archives-link">
            <a class="sub-nav-link"
               href="/archives">
                <span>Archives</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-series-link">
            <a class="sub-nav-link"
               href="/series">
                <span>series</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-notes-link">
            <a class="sub-nav-link"
               href="/notes">
                <span>notes</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-photos-link">
            <a class="sub-nav-link"
               href="/photos">
                <span>photos</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-tiny-tools-link">
            <a class="sub-nav-link"
               href="/collections/tiny-tools">
                <span>tiny-tools</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-projects-link">
            <a class="sub-nav-link"
               href="/projects">
                <span>projects</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-about-link">
            <a class="sub-nav-link"
               href="/about">
                <span>About</span>
              </a>
          </li>
        
          
          <li class="menu-item" id="nav-feeds-link">
            <a class="sub-nav-link"
               href="/feeds">
                <span>Feeds</span>
              </a>
          </li>
        
      </ul>
    </nav>
    <div id="header-nav-end"></div>
  </div>
  <div id="progress"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
        <a href="/" id="logo">
          <h1 id="title-wrap">
            <span style="opacity:0.2;">kiko.io</span>
          </h1>
        </a>
      
        <h2 id="subtitle">
          Memorable Tech Stuff
        </h2>
        <div id="sub-socialmediaimage-link" onclick="copysocialmediaimageLink();"></div>
        <script>
          function copysocialmediaimageLink() {
            let smil = document.querySelector('meta[property="og:image"]').content;
            copyTextToClipboard(smil);
          }
        </script>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        <div id="sub-nav-theme">          
          <input type="checkbox" id="theme-switch">
          <label for="theme-switch"></label>
        </div>
      </nav>
    </div>
  </div>
</header>
<script>
  if (location.pathname === "/") {
    document.getElementById("nav-home-link").remove();
  }
</script>
  <div id="content" class="outer">
    <main class="">
  <style>
#banner {
    background-size: cover;
}
@media screen and (max-width: 479px) {
    #banner { background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 75%), url("/photos/mobile/D50_7484.jpg"); }
}
@media screen and (min-width: 480px) and (max-width: 767px) {
    #banner { background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 75%), url("/photos/tablet/D50_7484.jpg"); }
}
@media screen and (min-width: 768px) {
    #banner { background-image: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 75%), url("/photos/normal/D50_7484.jpg"); }    
}
</style>

<img id="header-photo" data-pagefind-meta="image[src], image_alt[alt]"
     src="/photos/normal/D50_7484.jpg" 
     alt="Garden Beauties XV"
     width="0" height="0"/>


    <script>
        var header = document.getElementById("header");
        header.classList.add("photograph");
        
        var photoLink = document.getElementById("header-photo-link");
        photoLink.href = "/photos/D50_7484";
        photoLink.innerHTML = "<strong>Garden Beauties XV</strong>";
    </script>




<script>
  var body = document.getElementById("body");
  body.classList.add("article-view");
</script>
  
<article id="post-2023/Extension-of-downupPopup-Back-Button-Escape-Key-More" data-pagefind-body data-pagefind-meta="type:Article"
         class="article article-type-post h-entry">
  
  <div class="article-meta" data-pagefind-ignore>
    <div class="h-card p-author" style="display:none">
      <img class="u-photo" src="/images/kristof-zerbe.png" alt="Kristof Zerbe" />
      <a class="p-name u-url" href="https://kiko.io" rel="author">Kristof Zerbe</a>
    </div>
    <a class="u-url u-uid" href="https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/" style="display:none;">https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/</a>
    <a href="/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/" class="article-date">
  
  <time class="published dt-published" data-pagefind-meta="date" 
        datetime="2023-07-04T11:07:38.000Z">04 Jul 2023</time>
</a>
    
  <div class="article-category p-category category-ui/ux">
    <a class="article-category-link" href="/categories/UI-UX/">UI/UX</a> 
  </div>

  </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        




        


  
    <h1 class="article-title p-name" data-pagefind-ignore
        data-title="Extension of downupPopup: Back Button, Escape Key &amp; More" 
        data-pagefind-meta="title[data-title]">
        
        <span>Extension of downupPopup: Back Button, Escape Key &amp; More</span>
    </h1>
  

        
    <h2 class="article-subtitle p-summary">
        Contributing to Ali Dinçer&#39;s Bottom Sheet project
    </h2>

      </header>
    
    
    <div class="article-entry e-content">
      <p>I recently introduced a Bottom Sheet dialog on this blog to display a page’s metadata (<a href="javascript:dialog.pageMeta()">like this</a>), using Ali Dincer’s work: <a href="https://downuppopupjs.dincerali.com/"><strong>downupPopup</strong></a>. I described the way to do this in <a href="/post/Show-pages-meta-data-JSON-LD-in-Bottom-Sheet/">a post</a> a couple three weeks ago.</p>
<p>Shortly after that <a href="https://octodon.social/@koos">Koos Looijensteijn</a> triggered me with his post <a href="https://www.kooslooijesteijn.net/blog/digital-business-cards-vcard-qr-code-website">How to make digital business cards and share them via QR codes</a> and I felt like using my newly introduced dialog manager based on downupPopup for my own contact card.<br><strong>But more about that at a later time, respectively blog post…</strong></p>
<p>Important for this post is that Ali’s bottom sheet solution did not offer everything I wanted for my implementation:</p>
<h2 id="1-Make-Dialog-Reusable"><a href="#1-Make-Dialog-Reusable" class="headerlink" title="1. Make Dialog Reusable"></a>1. Make Dialog Reusable</h2><p>As I have already described in the above mentioned article: Ali’s approach to calling the dialog was to create and initialize the necessary HTML elements if it didn’t already exist in the DOM. I pulled out the initialization to make the component reusable. There is now a preparation part and an initialization part and the latter is always called, no matter if another bottom sheet dialog was already created before.</p>
<p><a href="https://github.com/ali-dincer/downupPopup.js/pull/2/commits/f3751ca56c4809decc1ec3845e5c301a13292773">My GitHub commit on this part</a>…</p>
<span id="more"></span>

<hr>
<h2 id="2-Dynamic-Distance"><a href="#2-Dynamic-Distance" class="headerlink" title="2. Dynamic Distance"></a>2. Dynamic Distance</h2><p>Since it makes no sense to have to scroll around on a contact card if the space provided by the web designer is not sufficient at small resolutions, I need a more dynamic approach to Ali’s <em><code>distance</code></em>, which sets the distance of the bottom sheet to the top of the viewport. </p>
<p>To do this, I introduced a new setting called <strong><code>minContentHeight</code></strong> that can specify in pixels how high the content must be at least for everything to be visible. Because this makes the possibly specified <code>distance</code> absurd,  I overwrite this specification with a value calculated with it and only then enter the distance value into the element attribute for further use. </p>
<p>For the calculation to be correct, however, I need a fixed value for the HEADER of the dialog at this point, which was previously only defined in the CSS. In retrospect, this was a good decision, because once slight pixel shifts between HEADER and CONTENT disappeared in Google’s Chrome, my preferred browser.</p>
<figure class="highlight js"><figcaption><span>downupPopup.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Option Handling</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> settings = $.<span class="title function_">extend</span>(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">minContentHeight</span>: <span class="literal">null</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialization</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// setting header height</span></span><br><span class="line"><span class="keyword">const</span> $head = $this.<span class="title function_">find</span>(<span class="string">&quot;.downupPopup-header&quot;</span>);</span><br><span class="line">$head.<span class="title function_">find</span>(<span class="string">&quot;span&quot;</span>).<span class="title function_">text</span>(settings.<span class="property">headerText</span>);</span><br><span class="line"><span class="keyword">const</span> headH = <span class="number">6</span>;</span><br><span class="line">$head.<span class="title function_">css</span>(<span class="string">&#x27;height&#x27;</span>, <span class="string">&#x27;&#x27;</span> + headH + <span class="string">&#x27;vh&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// calculating dynamic distance by given minContentHeight</span></span><br><span class="line"><span class="keyword">if</span> (settings.<span class="property">minContentHeight</span>) &#123; </span><br><span class="line">  <span class="keyword">let</span> calcDistance = <span class="title class_">Math</span>.<span class="title function_">round</span>((<span class="number">100</span> * (<span class="variable language_">window</span>.<span class="property">innerHeight</span> - settings.<span class="property">minContentHeight</span>) / <span class="variable language_">window</span>.<span class="property">innerHeight</span>)) - headH;</span><br><span class="line">  settings.<span class="property">distance</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, calcDistance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$this.<span class="title function_">attr</span>(<span class="string">&#x27;distance&#x27;</span>, settings.<span class="property">distance</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// setting distance to top</span></span><br><span class="line"><span class="keyword">const</span> $cont = $this.<span class="title function_">find</span>(<span class="string">&quot;.downupPopup-content&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> contH = <span class="number">100</span> - settings.<span class="property">distance</span> - headH;</span><br><span class="line">$cont.<span class="title function_">css</span>(<span class="string">&#x27;height&#x27;</span>, <span class="string">&#x27;&#x27;</span> + contH + <span class="string">&#x27;vh&#x27;</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/ali-dincer/downupPopup.js/pull/2/commits/0b1b72a4dd5ceb4b1436540a44c24f256f92a1ad">My GitHub commit on this part</a>…</p>
<hr>
<h2 id="3-Closing-Dialog-by-ESC-Key-or-BACK-Button"><a href="#3-Closing-Dialog-by-ESC-Key-or-BACK-Button" class="headerlink" title="3. Closing Dialog by ESC Key or BACK Button"></a>3. Closing Dialog by ESC Key or BACK Button</h2><p>With Koos’ really nice <a href="https://www.fortomorrow.eu/en/contact/koos">contact card</a>, I noticed that I automatically tried to close his SHARE DATA popup dialog with the QRCode, which is created on-the-fly with JavaScript, with the BACK button, but ended up on a completely different, previously called page. I guess this is a psychological thing: if an element not bound to the url overlaps the current page, people (or just me?) perceives it as an independent page and try to navigate with long learned methods.</p>
<p>So what was missing was, on the one hand, the ability to close the dialog using the <strong>ESCAPE key</strong> (for desktop users) and, on the other hand, to manipulate the URL history so that the <strong>BACK button</strong> or the corresponding mobile gesture works as expected.</p>
<p>For the latter I needed again a new setting: the hash which will be added to the current URL to make the BACK button work: <code>urlHash</code>. </p>
<p>In addition, there were several redundant places in the original code, with which the dialog was closed, which I have summarized in a function, in order to avoid the new necessary to write several times. (<a href="https://github.com/ali-dincer/downupPopup.js/pull/2/commits/fa0e119b42a444f1cb671d02381029f662d94591">my GitHub commit on this part</a>).</p>
<figure class="highlight js"><figcaption><span>downupPopup.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Option Handling</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> settings = $.<span class="title function_">extend</span>(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">urlHash</span>: <span class="literal">null</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// General CLOSE function</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// unbind ESC</span></span><br><span class="line">  $(<span class="variable language_">document</span>).<span class="title function_">off</span>(<span class="string">&#x27;keyup&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove url hash &amp; unbind BACK button</span></span><br><span class="line">  <span class="keyword">if</span> (settings?.<span class="property">urlHash</span> || $this.<span class="title function_">attr</span>(<span class="string">&#x27;hash&#x27;</span>)) &#123;</span><br><span class="line">    history.<span class="title function_">replaceState</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    $(<span class="variable language_">window</span>).<span class="title function_">off</span>(<span class="string">&quot;popstate&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialization</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// bind ESC to close</span></span><br><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">on</span>(<span class="string">&#x27;keyup&#x27;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(event.<span class="property">key</span> == <span class="string">&quot;Escape&quot;</span>) &#123;</span><br><span class="line">    <span class="title function_">close</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (settings.<span class="property">urlHash</span>) &#123;</span><br><span class="line">  <span class="comment">// set url hash &amp; bind BACK button to close</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hash</span> = settings.<span class="property">urlHash</span>;</span><br><span class="line">  $(<span class="variable language_">window</span>).<span class="title function_">on</span>(<span class="string">&quot;popstate&quot;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">close</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$this.<span class="title function_">attr</span>(<span class="string">&#x27;hash&#x27;</span>, settings.<span class="property">urlHash</span>);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>The key of this code regarding the BACK button is to put the passed hash into the URL when initializing the dialog via <code>window.location.hash</code> and to make sure that it is closed when the hash is removed again by the BACK button. I achieved this by using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/popstate_event"><code>popstate</code></a> event, which fires when the active history entry changes.</p>
<p>When the dialog is about to close, I had to make sure that the <code>history</code> entry is overwritten via <a href="https://developer.mozilla.org/en-US/docs/Web/API/History/replaceState"><code>replaceState</code></a> with <code>null</code> (delete) and remove the previously bound <code>popstate</code> event again, to avoid side effects.</p>
<p>The code for the ESC key is similar: Bind the <code>keyup</code> event on startup to close the dialog and remove it again on close.</p>
<p><a href="https://github.com/ali-dincer/downupPopup.js/pull/2/commits/1577a0e6306f75101afb09dc05f7abf80dc29e40">My GitHub commit on this part</a>…</p>
<hr>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Everything works as expected and I hope that Ali will process my pull request soon. Until then you can find the code <a href="https://github.com/kristofzerbe/downupPopup.js">in my fork</a>.</p>
<p>All in all, the script has not become more readable or easier to maintain, even by using jQuery. In my head I already have the idea to do a complete rewrite as ESM class. Reason for this is surely Ali’s approach to realize commands like ‘open’ and ‘close’ as string parameters. This works better than real functions of an instantiated object. Furthermore, it is necessary to cache settings like <code>distance</code> and <code>urlHash</code> in HTML attributes, which does not have to be this way.</p>

    </div>
    
    <footer class="article-footer" data-pagefind-ignore>      
      
  <div class="article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Contributing/" rel="tag">Contributing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GitHub/" rel="tag">GitHub</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UI/" rel="tag">UI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jQuery/" rel="tag">jQuery</a></li></ul>  
  </div>

      
  
  
    <div class="article-syndication">
      
          <a class="syndication-link u-syndication fab fa-mastodon" 
            href="https://indieweb.social/@kiko/110657193763601130" title="Syndication on Mastodon" rel="syndication" target="_blank"></a>
      
    </div>
  

      <div class="article-permalink" id="article-permalink-clnqlecd40034kaq3etwf1oeb">
    <input class="article-permalink-value" value="https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/" 
           data-id="clnqlecd40034kaq3etwf1oeb" data-title="Extension of downupPopup: Back Button, Escape Key &amp; More" />
    <a class="article-action action-copy" title="Copy URL"></a>
    <a class="article-action action-share" title="Open Share Dialog"></a>
</div>
<script>
    window.addEventListener("load", () => {
        initPermalink("clnqlecd40034kaq3etwf1oeb");
    });
</script>

      
    </footer>

  </div>

  
  

<div class="article-share" data-pagefind-ignore>
  <button onclick="dialog.shareOnMastodon();" class="share mastodon">Share on Mastodon</button>
</div>

<div class="article-interaction" data-pagefind-ignore>
  <p>
    You can interact with this article (applause, criticism, whatever) 
    by mention it in one of your posts or by replying to its syndication on <a class="mastodon" href="https://indieweb.social/@kiko/110657193763601130">Mastodon</a>, which will also be shown here as a  
    <a href="https://en.wikipedia.org/wiki/Webmention"><em>Webmention</em></a> ... or you leave a good old comment with your GitHub account.   
  </p>
</div>

<div class="article-webmentions" data-pagefind-ignore>
  <h2>Webmentions</h2>

  <div class="webmentions-placeholder">
    <p class="wm-placeholder">No Webmentions yet...</p>
  </div>

  <p class="webmention-form-info">
    In case your blog software can't send Webmentions, 
    you can use this form to submit me a mention of this article...
  </p>

  <form class="webmention-form" action="https://webmention.io/kiko.io>/webmention" name="webmention-form"
    method="post">
    <label for="webmention-form-source">Your Article URL:</label><br>
    <input class="webmention-form-source" type="url" name="source" placeholder="https://your-blog.com/your-article"
      required="">
    <input type="hidden" name="target" value="https://kiko.io/post/Extension-of-downupPopup-Back-Button-Escape-Key-More/">
    <input type="submit" value="Send Webmention">
  </form>

  <script>
    window.addEventListener('load', function () {
      insertWebmentions('2023/Extension-of-downupPopup-Back-Button-Escape-Key-More', 'https://kiko.io', 'Kristof Zerbe');
    });
  </script>

  

</div>


<div class="article-comments" data-pagefind-ignore>
  <h2>Comments</h2>
  <div id="comment-placeholder"></div>
  <script>
    window.addEventListener('load', function () {
      insertUtterancesCommentBlock();
    });
  </script>
</div>

  
  <div class="article-related">
    <h2>Related</h2>
    <div class="archives">
      
        
        <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      
    <a href="/post/Show-pages-meta-data-JSON-LD-in-Bottom-Sheet/">
        <img class="archive-article-photo" src="/photos/tablet/22-08 Bretagne-Jersey-0683.jpg" alt="Water Numbers" />
    </a>

    </header>
    <div class="archive-article-content">
      <a href="/post/Show-pages-meta-data-JSON-LD-in-Bottom-Sheet/" class="archive-article-date">
  
  <time class="published dt-published" data-pagefind-meta="date" 
        datetime="2023-06-11T12:11:45.000Z">11 Jun 2023</time>
</a>
      
  <div class="archive-article-category category-ui/ux">
    <a class="article-category-link" href="/categories/UI-UX/">UI/UX</a> 
  </div>

      




      


  
    <h1>
      <a class="archive-article-title"
         href="/post/Show-pages-meta-data-JSON-LD-in-Bottom-Sheet/">Show pages meta data (JSON-LD) in Bottom Sheet</a>
    </h1>
  

      
    <h2 class="archive-article-subtitle">
        Visualize the generated meta code on your page in a sliding panel for review and information purposes
    </h2>
              
    </div>
    <div class="archive-article-footer">
      
  <div class="archive-article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JSON-LD/" rel="tag">JSON-LD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Meta/" rel="tag">Meta</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Publishing/" rel="tag">Publishing</a></li></ul>  
  </div>

    </div>
</div>
</article>
        
      
        
        <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      
    <a href="/post/Provide-Blog-Metadata-via-JSON-LD/">
        <img class="archive-article-photo" src="/photos/tablet/D70_9216.jpg" alt="Broken Onion" />
    </a>

    </header>
    <div class="archive-article-content">
      <a href="/post/Provide-Blog-Metadata-via-JSON-LD/" class="archive-article-date">
  
  <time class="published dt-published" data-pagefind-meta="date" 
        datetime="2023-02-09T23:00:00.000Z">10 Feb 2023</time>
</a>
      
  <div class="archive-article-category category-tools">
    <a class="article-category-link" href="/categories/Tools/">Tools</a> 
  </div>

      


    <a class="archive-article-anything" href="/series/a-new-blog">A New Blog</a>



      


  
    <h1>
      <a class="archive-article-title"
         href="/post/Provide-Blog-Metadata-via-JSON-LD/">Provide Blog Metadata via JSON-LD</a>
    </h1>
  

      
    <h2 class="archive-article-subtitle">
        Centralization of a website&#39;s schema.org data in the HEAD instead of everywhere in the HTML
    </h2>
              
    </div>
    <div class="archive-article-footer">
      
  <div class="archive-article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JSON-LD/" rel="tag">JSON-LD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Search/" rel="tag">Search</a></li></ul>  
  </div>

    </div>
</div>
</article>
        
      
        
        <article class="archive-article archive-type-post">
  <div class="archive-article-inner">
    <header class="archive-article-header">
      
    <a href="/post/Discoveries-24-JavaScript-UI/">
        <img class="archive-article-photo" src="/photos/tablet/DSC_2186.jpg" alt="Sweat Lodge" />
    </a>

    </header>
    <div class="archive-article-content">
      <a href="/post/Discoveries-24-JavaScript-UI/" class="archive-article-date">
  
  <time class="published dt-published" data-pagefind-meta="date" 
        datetime="2023-04-28T14:39:01.000Z">28 Apr 2023</time>
</a>
      
  <div class="archive-article-category category-misc">
    <a class="article-category-link" href="/categories/Misc/">Misc</a> 
  </div>

      


    <a class="archive-article-anything" href="/series/discoveries">Discoveries</a>



      


  
    <h1>
      <a class="archive-article-title"
         href="/post/Discoveries-24-JavaScript-UI/">Discoveries #24 - JavaScript &amp; UI</a>
    </h1>
  

                    
    </div>
    <div class="archive-article-footer">
      
  <div class="archive-article-tags">
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Collection/" rel="tag">Collection</a></li></ul>  
  </div>

    </div>
</div>
</article>
        
      
    </div>
  </div>

  
<nav id="article-nav">
  
    <a href="/post/CONTINUE-READING-Link-Auto-Scrolling-on-the-called-page/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CONTINUE READING Link &amp; Auto Scrolling on the called page
        
      </div>
    </a>
  
  
    <a href="/post/Discoveries-25-Tutorials-HowTo-s/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Discoveries #25 - Tutorials &amp; HowTo&#39;s</div>
    </a>
  
</nav>

  

</article></main>
    
      <aside id="sidebar">
  
    <div class="widget-wrap">
    <div class="widget about h-card"><!--http://microformats.org/wiki/h-card-->
        <div class="avatar">
            <a href="/about"><img class="u-photo" src="/images/kristof-zerbe.png" alt="Kristof Zerbe"></a>
            <a href="https://github.com/kristofzerbe" target="_blank" class="fab fa-github" rel="me"></a>
            <a href="https://www.xing.com/profile/Kristof_Zerbe" target="_blank" class="fab fa-xing" rel="me"></a>
            <a href="https://www.linkedin.com/in/kristof-zerbe-91012510/" target="_blank" class="fab fa-linkedin" rel="me"></a>      
            <a href="https://500px.com/kikon" target="_blank" class="fab fa-500px" rel="me"></a>
            <a href="https://indieweb.social/@kiko" target="_blank" class="fab fa-mastodon" rel="me"></a>
            <a href="https://pixelfed.social/kristofz" target="_blank" class="fab fa-pixelfed" rel="me"></a>
        </div>
        <h3 class="p-name">Kristof Zerbe</h3>
        <p class="p-note">
            <i class="p-role">Developer & Team Lead</i> located in <i class="p-locality">Wiesbaden</i>, <i class="p-country-name">Germany</i>
        </p>
        <a class="u-url u-uid" href="https://kiko.io" style="display:none;"></a>
    </div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            
              <a href="/post/Get-and-use-a-dominant-color-that-matches-the-header-image/">Get and use a dominant color that matches the header image</a>
            
          </li>
        
          <li>
            
              <a href="/post/SVWW-vs-HSV-2023-10-07/">SVWW vs. HSV @ 2023-10-07</a>
            
          </li>
        
          <li>
            
              <a href="/post/Majorcan-Details/">Majorcan Details</a>
            
          </li>
        
          <li>
            
              <a href="/post/Mastodon-Share-Bottom-Sheet-Dialog/">Mastodon Share Bottom Sheet Dialog</a>
            
          </li>
        
      </ul>
    </div>
  </div>

  

  <div class="widget widget-wrap">
    <p>
      Want more? This way ... to the <a href="/archives">archives</a>
    </p>
  </div>  
</aside>
    
  </div>
  <footer id="footer">
  
  <div class="outer">
    <div class="inner">

      <ul id="footer-dots">
        <li class="dot"><a href="https://search.google.com/search-console?resource_id=sc-domain%3Akiko.io" title="SearchConsole"></a></li>
        <li class="dot"><a href="https://kiko-io.pirsch.io/" title="Pirsch"></a></li>
        <li class="dot"><a href="https://webmentions.kiko.io" title="Webmention Analytics"></a></li>
      </ul>

      <div id="footer-info" class="footer-block">
        &copy; 2019-2023&nbsp;&nbsp;Kristof Zerbe
        <span class="dot-space">&#9679;</span>
        Powered by <a href="https://hexo.io/">Hexo</a> & <a href="https://github.com/">GitHub</a>
      </div>

      <div id="footer-links">
        
        <a href="/about">About</a>
        <span class="dot-space">&#9679;</span>
        
        <a href="/impressum">Impressum</a>
        <span class="dot-space">&#9679;</span>
        
        <a href="/feeds">Feeds</a>
        <span class="dot-space">&#9679;</span>
        
        <a href="javascript:dialog.pageMeta();">Page Meta</a>
      </div>

      <div id="footer-perf">
        Page loaded in <span class="perf-loadtime">0</span> at <span class="perf-viewport"></span>
        <script>
          window.addEventListener("resize", function () {
            const height = document.documentElement.clientHeight;
            const width = document.documentElement.clientWidth;
            document.querySelector("#footer-perf span.perf-viewport").innerHTML = `${width} x ${height}`;
          });
          window.addEventListener("load", function () {
            const pageEnd = performance.mark("pageEnd")
            const loadTime = pageEnd.startTime / 1000;
            document.querySelector("#footer-perf span.perf-loadtime").innerHTML = loadTime.toFixed(2);
            window.dispatchEvent(new Event('resize'));
          });
        </script>
      </div>

      <div id="webring">
        <a id="webring-prev" class="webring-link" href="https://xn--sr8hvo.ws/%F0%9F%A7%80%F0%9F%91%9F%F0%9F%8E%8A/previous">&nbsp;</a>
        <a href="https://xn--sr8hvo.ws">IndieWeb Webring&nbsp;🕸💍</a>
        <a id="webring-next" class="webring-link" href="https://xn--sr8hvo.ws/%F0%9F%A7%80%F0%9F%91%9F%F0%9F%8E%8A/next">&nbsp;</a>
      </div>

    </div>
  </div>
</footer>
  <script>
  let isOffline = 'false' === 'true';
</script>


<script src="/js/jquery-3.6.0.min.js"></script>


<script src="/js/dist/bundle.min.js"></script>


<script src="/js/script.js"></script>


<script src="/js/dist/qr-code-styling.js"></script>


<script src="/js/dist/tinycolor-min.js"></script>


<script src="/js/dist/qr-code-styling-options-contact.json" id="qr-code-styling-options" type="application&#x2F;json"></script>


<script>
  //--- eval url hash on load
  var hash = window.location.hash.substr(1);
  switch (hash.toLowerCase()) {
    case "contact":
      window.addEventListener('load', function () {
        dialog.contact();
      });
      break;
    case "continue":
      //has no offset due to fixed header
      //...document.getElementById("more").scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest"});
      window.scrollTo({
        behavior: 'smooth',
        top:
          document.querySelector("#more").getBoundingClientRect().top -
          document.body.getBoundingClientRect().top -
          200,
      });
      history.replaceState(null, null, ' '); // remove hash
    default: break;
  }
</script>

<script>
  /*** DEFINITIONS */

  //HEADER
  var header = {
    height: 0,
    top: 0,
    offset: 55,
    photoLinkOpacity: 0,
    titleFontSize: 0
  };
  function initHeader() {
    $("#header").css("height", ""); //reset inline css
    $("#header-title").css("top", "");
    $("#header-photo-link").css("opacity", "");
    $("#title-wrap").css("font-size", "");
    header.height = $("#header").height(); //set from given css
    header.top = parseFloat($("#header-title").css("top"));
    header.photoLinkOpacity = parseFloat($("#header-photo-link").css("opacity"));
    header.titleFontSize = parseFloat($("#title-wrap").css("font-size"));

    //change subtitle a bit
    let sub = $("#header").find("#subtitle");
    let col = sub.css("color");
    let rpl = `<span style="text-decoration:line-through;color:rgb(120 120 120)" title="not only anymore"><span style="color:${col};opacity:0.75">Tech</span></span>`;
    let txt = sub.text().trim().replace('Tech', rpl);
    sub.html(txt);

    scrollHeader();
  }
  function scrollHeader() {
    var h = header.height - header.offset,
        st = $(document).scrollTop(),  
        d = (h - st),
        p = (d / h),
        hfs = header.titleFontSize / 5 * 3,
        jSide = $("aside");
    if (d > 0) {
      $("#header").css("height", d + header.offset + "px");
      $("#header-photo-link").css("opacity", header.photoLinkOpacity * p);
      $("#banner").css("opacity", p);
      $("#title-wrap").css("font-size", header.titleFontSize - ( header.titleFontSize / 3) * (1 - p) );
      $("#header-title").css("top", header.top - (hfs * (1 - p)) + "px");
      $("#subtitle").css("opacity", p);
      jSide.css("max-width", "").css("position", "").css("top", "");
    } else {
      $("#header").css("height", header.offset + "px");
      $("#header-photo-link").css("opacity", 0);
      $("#banner").css("opacity", 0);
      $("#title-wrap").css("font-size", header.titleFontSize - ( header.titleFontSize / 3) * (1) );      
      $("#header-title").css("top", header.top - (hfs * (1)) + "px");      
      $("#subtitle").css("opacity", 0);
      if (window.matchMedia("screen and (min-width: 768px)").matches & window.innerHeight > (jSide.height() + 50)) {
        jSide.css("max-width", $("aside").width()).css("position", "fixed").css("top", "50px");
      }
    }    
  }

  // IMAGE VIEWPORT
  function isVisibleInViewPort(e) {
    var viewTop = $(window).scrollTop();
    var viewBottom = viewTop + $(window).height();
  
    var eTop = $(e).offset().top;
    var eBottom = eTop + $(e).height();
  
    return ((eBottom <= viewBottom) && (eTop >= viewTop));
  }
  function initViewportImage() {
    $(".article-photo, .archive-article-photo, .card-img, .img-link").each(function() {
      if (isVisibleInViewPort($(this))) {
        $(this).addClass("in-view");
      } else {
        $(this).removeClass("in-view");
      }
    });
  }

  //SCROLL PROGRESS
  function initScrollProgress() {

    // Create ScrollTimeline
    const myScrollTimeline = new ScrollTimeline({
      source: document.scrollingElement,
      scrollSource: document.scrollingElement, // For legacy implementations
      orientation: 'block',
        scrollOffsets: [
            new CSSUnitValue(0, 'percent'),
            new CSSUnitValue(100, 'percent'),
        ],
    });

    // Animate Progress Bar on Scroll
    document.querySelector("#progress").animate(
      {
        transform: ["scaleX(0)", "scaleX(1)"]
      },
      { 
        duration: 1, 
        fill: "forwards", 
        timeline: myScrollTimeline 
      }
    );
  }

  // HORIZONTAL NAV MENU SCROLL
  function initNavMenuScroll() {
    const nav = document.querySelector('#header-nav');
    const menu = nav.querySelector('.menu');
    const firstMenuItem = menu.querySelector('.menu-item:first-child');
    const lastMenuItem = menu.querySelector('.menu-item:last-child');

    firstMenuItem.setAttribute("data-scim", "start");
    lastMenuItem.setAttribute("data-scim", "end");
    
    let observer = new IntersectionObserver((entries, observer) => { 
      entries.forEach(entry => {

        let scimElement = document.querySelector("#header-nav-" + entry.target.getAttribute("data-scim"));
        if (entry.intersectionRatio != 1) { 
          scimElement.classList.add("show");
        } else {
          scimElement.classList.remove("show");
        }
      });
    }, {threshold: 1});
    
    observer.observe(firstMenuItem);
    observer.observe(lastMenuItem);
  }

  //THEME
  function initColorScheme() {
    /* https://stackoverflow.com/questions/56300132/how-to-over-ride-css-prefers-color-scheme-setting */

    var theme = "light"; //default

    // get last used theme from local cache
    if (localStorage.getItem("theme")) {
      if (localStorage.getItem("theme") === "dark") {
        theme = "dark";
      }
    } else if (!window.matchMedia) {
      return false;
    } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      theme = "dark";
    }

    if (theme === "dark") {
      setThemeDark();
    } else {
      setThemeLight();
    }
  }
  function setThemeDark() {
    localStorage.setItem("theme", "dark");
    document.documentElement.setAttribute("data-theme", "dark");
    toggleTheme.checked = true;
    setVibrantColor("dark");
    setCodepenTheme();
  }
  function setThemeLight() {
    localStorage.setItem("theme", "light");
    document.documentElement.setAttribute("data-theme", "light");
    toggleTheme.checked = false;
    setVibrantColor();
    setCodepenTheme();
  }
  function setCodepenTheme() {
    //https://codepen.io/kristofzerbe/embed/xxxxx?height=400&default-tab=js,result&theme-id=dark
    var pens = document.getElementsByClassName("codepen");
    for (var i = 0; i < pens.length; i++) {
      var src = pens[i].src;
      const arr = src.split("?");
      const params = arr[1].split("&").slice(0, -1);
      src =
        arr[0] +
        "?" +
        params.join("&") +
        "&theme-id=" +
        localStorage.getItem("theme");
      pens[i].src = src;
    }
  }

  //VIBRANT COLOR
  function setVibrantColor(theme) {
    try {
      let img = $("#photo-preload").attr("href");
      Vibrant.from(img).getPalette().then(palette => {
        let swatch = palette.DarkVibrant; //[|Dark|Light]Muted, [|Dark|Light]Vibrant
        let color = swatch.getHex();
        if (theme === "dark") {
          let tColor = tinycolor(color).darken(10);
          color = tColor.toHexString();
        }
        if(!$("#header").hasClass("no-vibrant")) {
          $("#header, #footer, #back-to-top").css("background-color", color);
        }
      });
    } catch (error) {
    }
  }
</script>

<script>
  /*** EVENTS */

  window.addEventListener('scroll', function() {
    scrollHeader();
    initViewportImage();
  }, { passive: true });

  window.addEventListener('resize', function() {
    initHeader();
    initViewportImage();
  });

  // TOGGLE THEME
  const toggleTheme = document.querySelector('input#theme-switch[type="checkbox"]');
  toggleTheme.addEventListener("change", function (e) {
    if (e.target.checked) { setThemeDark(); } 
    else { setThemeLight(); }
  }, false);

  // TOGGLE THEME BY OS
  var toggleOS = window.matchMedia("(prefers-color-scheme: dark)");
  toggleOS.addEventListener("change", function (e) {
    if (e.matches) { setThemeDark(); } 
    else { setThemeLight(); }
  });

  /*** INITS */
  // $(document).ready(function() {
    initHeader();
    initColorScheme();
    initViewportImage();
    initNavMenuScroll();
    initScrollProgress();
  // });

  // BACK-TO-TOP
  addBackToTop({ diameter: 30 });

  // MENU-ITEM-SCROLL
  let pathItem = window.location.pathname.split('/')[1].toLowerCase();
  if (pathItem === "collections") pathItem = window.location.pathname.split('/')[2].toLowerCase()
  setTimeout(() => {
    let e = document.getElementById(`nav-${pathItem}-link`);
    if (e) e.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
  }, 250);

  // AUTOTYPING
  setTimeout(function() {
    $("#title-wrap").empty();
    new AutoTyping({
      id: 'title-wrap',
      typeText: ['kiko.io'],
      textColor: '#fff',
      typeSpeed: 100,
      typeDelay: 100,
      showCursor: false,
      delete: false,
      typeInfinity: false
    }).init();
  }, 1000);

  //MEDIUM-ZOOM
  mediumZoom(document.querySelectorAll('img.zoom'), {
    background: 'rgba(55, 55, 55, 0.5)',
    margin: 20,
    scrollOffset: 10
  });

</script>


  <script>
    //HOOK LINKS FOR PIRSCH EVENT...

    //VSCODE
    let vscode = document.querySelectorAll(".brand-links .vscode").forEach(link => link.addEventListener("click", function() { pirsch("Open in VSCode"); }));
    
  </script>  

</body>
<template id="contact-dialog">
  <div class="contact-content">
    <div class="contact-card">
      <div class="contact-face face-front">
        <div class="contact-face-wrapper">
          <img class="photo" src="/images/kristof-zerbe.png" alt="Kristof Zerbe">
          <div class="header">
            <h3>Kristof Zerbe</h3>
            <h4>Developer & Team Lead</h4>
            <p>Wiesbaden, Germany</p>
            <p class="download">
              <label>Save my contact by<br>downloading my</label>
              <a href="/kristof-zerbe.vcf" download="kristof-zerbe.vcf" class="fa-icon-download">vCard</a>  
            </p>
          </div>
          <hr class="divider">
          <div class="info">
            <p>
              <label>Mail me at</label>
              <a href="mailto:kristof.zerbe@gmail.com" class="fa-icon-mail">kristof.zerbe@gmail.com</a>    
            </p>
            <p>
              <label>Call me at</label>
              <a href="tel:+491716998867" class="fa-icon-phone">+49 171 6998867</a>  
            </p>
            <p>
              <label>Connect with me via</label>
              <a href="https://www.linkedin.com/in/kristof-zerbe-91012510/" class="fa-icon-linkedin">LinkedIn</a>
            </p>
            <p>
              <label>Connect with me via</label>
              <a href="https://www.xing.com/profile/Kristof_Zerbe" class="fa-icon-xing">Xing</a>
            </p>
            <p>
              <label>Follow me on</label>
              <a href="https://indieweb.social/@kiko" class="fa-icon-mastodon">Mastodon</a>  
            </p>
            <p>
              <label>Review my projects on</label>
              <a href="https://github.com/kristofzerbe" class="fa-icon-github">GitHub</a>  
            </p>
            <p>
              <label>Review my photos on</label>
              <a href="https://500px.com/kikon" class="fa-icon-500px">500px</a>  
            </p>
            <p>
              <label>Comment my photos on</label>
              <a href="https://pixelfed.social/kristofz" class="fa-icon-pixelfed">Pixelfed</a>  
            </p>
          </div>
        </div>
        <div class="contact-face-flip">flip for qrcode</div>
      </div>
      <div class="contact-face face-back">
        <div class="contact-face-wrapper">
          <div class="header">
            <h3>Kristof Zerbe</h3>
            <h4>kiko.io/#contact</h4>
          </div>
          <hr class="divider">
          <div id="contact-qrcode" class="qrcode"></div>
        </div>
        <div class="contact-face-flip">flip for card</div>
      </div>
    </div>
  </div>
</template>
<template id="mastodon-share-dialog">
  <div class="mastodon-share-content">
    <section>
      <p id="mastodon-share-intro">
        <img src="/images/mastodon.svg" alt="Mastodon">
        There are many Mastodon instances out there. 
        Tell me yours and I will redirect you to the share dialog of your server:
      </p>
      <label for="mastodon-instance">Your Mastodon Instance</label>
      <div id="mastodon-instance-wrapper">
        <span>https://</span>
        <input id="mastodon-instance" name="intance" required />
      </div>
      <label for="mastodon-text">Text to share ...</label>
      <textarea id="mastodon-text" name="text" rows="8"></textarea>
      <button id="mastodon-share">Share</button>
    </section>
  </div>
</template>
</html>