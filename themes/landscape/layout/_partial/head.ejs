<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <%
    let meta = {
      type: "page",
      area: null,
      subarea: null,
      slug: null,
      title: null,
      description: null,
      photograph: config.hero,
      imageUrl: config.hero.url
    }

    let currentYear = new Date().getFullYear();

    if (page.photograph) {
      page.photograph.url = config.url + "/photos/normal/" + page.photograph.file
    }

    let excerpt;
    if (page._content) { 
      excerpt = page._content
        .replace(/^(\n)/, "") // Remove Leading break
        .replace(/\{%\s.*%\}\n/g, "") // Remove multi line Nunjucks Vars
        .replace(/\{%\s(post_link) (?<content>.+?)%\}/g, "($<content>)") // Replace single line Nunjucks vars with its content
        .replace(/(\n-{3})/g, "") // Remove MD horizontal lines
        .replace(/(```.+?```)/gim, "[code]") // Replace MD code blocks with placeholder
        .replace(/__|\*|!|\#|(?:\[([^\]]*)\]\([^)]*\))/g, "$1") // Replace other MD elements
        .split("\n")[0] // Get first paragraph
        .replace(/(\n){2,}/g, " ") // Remove Multiple breaks
        .substring(0, 150) + "...";
    }

    if      (is_home())     { meta.area = "HOME"; }
    else if (is_post())     { meta.area = "POST"; }
    else if (is_page())     { meta.area = "PAGE"; }
    else if (is_archive())  { meta.area = "ARCHIVE";
      if      (is_month())    { meta.subarea = "MONTH"; }
      else if (is_year())     { meta.subarea = "YEAR"; }
    }
    else if (is_category()) { meta.area = "CATEGORY"; }
    else if (is_tag())      { meta.area = "TAG"; }
    else {
      let rootPath = page.path.split(/[\\\/]/)[0].toLowerCase();
      switch (rootPath) {
        case "notes":
          meta.area = "NOTE";
          meta.subarea = page.path.split(/[\\\/]/)[1]; //year
          break;
        case "series":
        case "projects":
          meta.area = "ANYTHING"; 
          meta.subarea = rootPath.toUpperCase();
          break;
        case "collections":
        case "about":
        case "photos":
        case "search":
        case "console":
          meta.area = "DYNAMIC";
          break;
        default:
          meta.area = rootPath.toUpperCase();
          break;
      }
    }

    switch (meta.area) {
      case "HOME":
        meta.title = config.title + " - " + config.subtitle;
        meta.description = config.description;
        break;

      case "ARCHIVE":
        switch (meta.subarea) {
          case "MONTH": 
            meta.title = __("archive_a") + " " + page.year + "/" + page.month + " - " + config.title; 
            break;
          case "YEAR": 
            meta.title = __("archive_a") + " " + page.year + " - " + config.title; 
            break;
          default: 
            meta.title = __("archive_a") + " - " + config.title;
          break;
        }
        //--
        meta.description = config.description.replace("Blog", "Archive");
        break;

      case "CATEGORY":
        meta.title = __("category") + " " + page.category + " - " + config.title;
        meta.description = config.description.replace("Blog", "Archive");
        break;

      case "TAG":
        meta.title = __("tag") + " " + page.tag + " - " + config.title;
        meta.description = config.description.replace("Blog", "Archive");
        break;

      case "PAGE":
        meta.title = page.title + " - " + config.title;
        if (page.description) { 
          meta.description = page.description;
        } else { 
          meta.description = page.title + " " + config.description_short;
        }
        meta.photograph = page.photograph;
        meta.imageUrl = page.photograph.url;
        break;

      case "ANYTHING":
        meta.title = page.title + " - " + config.title;
        //--
        if (page.title === "Projects") {
          meta.description = page.title + " " + config.description_short;
        } else {
          meta.description = "Project '" + page.title + "' " + config.description_short;
        }
        if (page.title === "Series") {
          meta.description = page.title + " " + config.description_short;
        } else {
          meta.description = "Series '" + page.title + "' " + config.description_short;
        }
        //--
        if (meta.subarea === "PROJECTS") {
          meta.photograph = page.photograph;
          meta.imageUrl = page.photograph.url;
        }
        break;
 
      case "DYNAMIC":
        meta.title = page.title + " - " + config.title;
        meta.description = page.title + " " + config.description_short;
        meta.photograph = page.photograph;
        meta.imageUrl = page.photograph.url;
        break;

      case "POST":
        meta.title = page.title + " - " + config.title;
        //--
        if (page.description) {
          meta.description = page.description;
        } else {
          if (page.subtitle) {
            meta.description = page.subtitle;
          } else {
            meta.description = excerpt;
          }
        }
        //--
        let slugArray = page.slug.split("/"); //due to subfolders
        meta.slug = slugArray[slugArray.length - 1];
        meta.photograph = page.photograph;
        meta.imageUrl = config.url + "/images/social-media/" + meta.slug + ".png";
        meta.type = "article";
        break;

      case "NOTE":
        meta.title = page.title + " " + meta.subarea + " - " + config.title;
        //--
        if (page.title === "Notes") {
          meta.description = page.title + " of " + meta.subarea + " " + config.description_short;
        } else {
          if (page.description) {
            meta.description = page.description;
          } else {
            meta.description = excerpt;
          }
          meta.type = "blogposting";
        }
        //--
        meta.photograph = page.photograph;
        meta.imageUrl = meta.photoUrl;        

      default: 
        break;
    }
  %>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title><%= meta.title %></title>
  <meta name="author" content="<%= config.author %>">
  <meta name="title" content="<%= meta.title %>">
  <% if (meta.description) { %>
  <meta name="description" content="<%= meta.description %>">
  <% }%>

  <link rel="canonical" href="<%= url.replace("index.html", "") %>">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="<%- theme.favicon %>">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <meta name="theme-color" content="#444">

  <%#!-- JSON-LD (schema.org) for Google --%>
  <%
    let jsonPartial = "json-ld-" + meta.type;
    let jsonLD = partial('_partial/meta/' + jsonPartial, { meta: meta });
    try {
      jsonLD = jsonLD.replace(/\\/g, '\\\\');
      jsonLD = JSON.stringify(JSON.parse(jsonLD));
    } catch (error) {
      console.error(error);
      console.log(jsonLD)
    }
  %>
  <script type="application/ld+json"><%- jsonLD %></script>

  <%#!-- Open Graph --%>
  <meta property="og:site_name" content="<%= config.title %>">
  <meta property="og:type" content="blog">
  <meta property="og:url" content="<%= url %>">
  <meta property="og:title" content="<%= meta.title %>">
  <% if (meta.description) { %>
  <meta property="og:description" content="<%= meta.description %>">
  <% } %>
  <meta property="og:image" content="<%= meta.imageUrl %>">
  <meta property="og:locale" content="en_US">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="<%= url %>">
  <meta property="twitter:title" content="<%= meta.title %>">
  <% if (meta.description) { %>
  <meta property="twitter:description" content="<%= meta.description %>">
  <% } %>
  <meta property="twitter:image" content="<%= meta.imageUrl %>">

  <%#!-- webmention.io --%>
  <link rel="webmention" href="https://webmention.io/kiko.io/webmention" />
  <link rel="pingback" href="https://webmention.io/kiko.io/xmlrpc" />

  <%#!-- IndieAuth --%>
  <link rel="authorization_endpoint" href="https://indieauth.com/auth" />
  <link rel="token_endpoint" href="https://tokens.indieauth.com/token" />
  <link href="https://github.com/kristofzerbe" rel="me authn">
  <link href="mailto:kristof.zerbe@gmail.com" rel="me authn">
  
  <%#!-- Feed --%>
  <% if (theme.rss){ %>
    <link rel="alternate" href="<%= url_for(theme.rss) %>" title="<%= meta.title %>" type="application/atom+xml">
  <% } %>

  <link rel="preload" href="/css/fonts/opensans/opensans-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-italic.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-semibold.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/opensans/opensans-semibolditalic.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-Regular.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-It.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-Bold.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/sourcecodepro/WOFF2/TTF/SourceCodePro-BoldIt.ttf.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/fontawesome/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/fontawesome/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/css/fonts/fontawesome/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>

  <link rel="preload" as="image" href="/images/hero.jpg" imagesrcset="/images/hero-mobile.jpg 480w, /images/hero-tablet.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$search.jpg" imagesrcset="/photos/mobile/$search.jpg 480w, /photos/tablet/$search.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$notes-<%= currentYear %>.jpg" imagesrcset="/photos/mobile/$notes-<%= currentYear %>.jpg 480w, /photos/tablet/$notes-<%= currentYear %>.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$projects.jpg" imagesrcset="/photos/mobile/$projects.jpg 480w, /photos/tablet/$projects.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$tiny-tools.jpg" imagesrcset="/photos/mobile/$tiny-tools.jpg 480w, /photos/tablet/$tiny-tools.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$photos.jpg" imagesrcset="/photos/mobile/$photos.jpg 480w, /photos/tablet/$photos.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$about.jpg" imagesrcset="/photos/mobile/$about.jpg 480w, /photos/tablet/$about.jpg 768w">
  <link rel="preload" as="image" href="/photos/normal/$404.jpg" imagesrcset="/photos/mobile/$404.jpg 480w, /photos/tablet/$404.jpg 768w">

  <%- css('css/dist/bundle.min.css') %>
  <%- css('css/style.css') %>

  <%- js('js/tools.js') %>
  <%- js('js/dist/scroll-timeline.js') %>
  <%- js('js/dist/image-compare-viewer.min.js') %>
  <%- js('js/dist/tiny-slider.min.js') %>

<% if (config.pirsch.enabled === true) { %>
  <script defer type="text/javascript" 
    src="https://api.pirsch.io/pirsch.js"
    id="pirschjs"
    data-code="<%= config.pirsch.code %>"></script>
  <script type="text/javascript" 
    src="https://api.pirsch.io/pirsch-events.js"
    id="pirscheventsjs"
    data-code="<%= config.pirsch.code %>"></script>    
<% } %>

</head>
