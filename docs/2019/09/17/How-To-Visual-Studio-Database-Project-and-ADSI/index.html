<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>How-To: Visual Studio Database Project and ADSI | kiko.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="If you are working with a database project and try to work with data from the Active Directory via a linked server, you have the problem that you have to announce the data structure of the AD data in">
<meta name="keywords" content="ADSI,Visual Studio,Database Project">
<meta property="og:type" content="article">
<meta property="og:title" content="How-To: Visual Studio Database Project and ADSI">
<meta property="og:url" content="https://kristofzerbe.github.io/kiko.io/2019/09/17/How-To-Visual-Studio-Database-Project-and-ADSI/index.html">
<meta property="og:site_name" content="kiko.io">
<meta property="og:description" content="If you are working with a database project and try to work with data from the Active Directory via a linked server, you have the problem that you have to announce the data structure of the AD data in">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-09-21T15:31:10.952Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How-To: Visual Studio Database Project and ADSI">
<meta name="twitter:description" content="If you are working with a database project and try to work with data from the Active Directory via a linked server, you have the problem that you have to announce the data structure of the AD data in">
  
    <link rel="alternate" href="/atom.xml" title="kiko.io" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">kiko.io</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Memorable Tech Stuff</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="https://github.com/kristofzerbe">GitHub</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://kristofzerbe.github.io/kiko.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-How-To-Visual-Studio-Database-Project-and-ADSI" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/17/How-To-Visual-Studio-Database-Project-and-ADSI/" class="article-date">
  <time datetime="2019-09-17T15:03:00.000Z" itemprop="datePublished">2019-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      How-To: Visual Studio Database Project and ADSI
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you are working with a database project and try to work with data from the Active Directory via a linked server, you have the problem that you have to announce the data structure of the AD data in order to get the project compiled.</p>
<h3 id="Linking-to-the-Active-Directory"><a href="#Linking-to-the-Active-Directory" class="headerlink" title="Linking to the Active Directory"></a>Linking to the Active Directory</h3><p>First of all you have to connect your SQL Server to the AD permanently, via following SQL script:</p>
<pre><code>USE [master]
GO
EXEC master.dbo.sp_addlinkedserver @server = N&apos;ADSI&apos;, 
    @srvproduct=N&apos;Active Directory Service Interfaces&apos;, 
    @provider=N&apos;ADSDSOObject&apos;, 
    @datasrc=N&apos;adsdatasource&apos;

EXEC master.dbo.sp_addlinkedsrvlogin @rmtsrvname=N&apos;ADSI&apos;,
    @useself=N&apos;False&apos;,
    @locallogin=NULL,
    @rmtuser=N&apos;mydomain\myadminuser&apos;,
    @rmtpassword=&apos;mypassword&apos;
GO

EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;collation compatible&apos;, @optvalue=N&apos;false&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;data access&apos;, @optvalue=N&apos;true&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;dist&apos;, @optvalue=N&apos;false&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;pub&apos;, @optvalue=N&apos;false&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;rpc&apos;, @optvalue=N&apos;false&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;rpc out&apos;, @optvalue=N&apos;false&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;sub&apos;, @optvalue=N&apos;false&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;connect timeout&apos;, @optvalue=N&apos;0&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;collation name&apos;, @optvalue=null
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;lazy schema validation&apos;, @optvalue=N&apos;false&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;query timeout&apos;, @optvalue=N&apos;0&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;use remote collation&apos;, @optvalue=N&apos;true&apos;
GO
EXEC master.dbo.sp_serveroption @server=N&apos;ADSI&apos;, 
    @optname=N&apos;remote proc transaction promotion&apos;, @optvalue=N&apos;true&apos;
GO</code></pre><h3 id="Fetching-ADSI-data"><a href="#Fetching-ADSI-data" class="headerlink" title="Fetching ADSI data"></a>Fetching ADSI data</h3><p>To get data, you use <code>OpenQuery</code> against the Linked Server.<br>In order to get only persons and no system accounts, you should filter out all users,which has no firstname (<code>givenName</code>) or lastname (<code>sn</code>):</p>
<pre><code>SELECT 
    UserPrincipalName, 
    DisplayName, 
    sAMAccountName AS [SamAccountName], 
    sn AS [LastName], 
    givenName AS [FirstName], 
    title AS [Title], 
    Mail as [MailAddress],
    department AS [Department],
    l AS [Location], 
    postalCode AS [PostCode], 
    streetAddress AS [Street],
    st AS [State]
FROM OpenQuery(ADSI, &apos;
    SELECT 
        UserPrincipalName, 
        DisplayName, 
        sAMAccountName, 
        sn, 
        givenName, 
        department,
        title, 
        Mail, 
        l, 
        postalCode, 
        streetAddress, 
        st
    FROM &apos;&apos;LDAP://mydomain.de/DC=mydomain,DC=de&apos;&apos; 
    WHERE objectClass =  &apos;&apos;User&apos;&apos; 
    AND objectCategory = &apos;&apos;Person&apos;&apos; 
    AND sn=&apos;&apos;*&apos;&apos; 
    AND givenName = &apos;&apos;*&apos;&apos; 
&apos;)    </code></pre><p>In most cases you’re done with that … except your organisation has more the 900 users!<br>Then you have to split the fetch in several requests, because SQL Server quits with an error, when trying to read more than 900 records via ADSI.  </p>
<p>Best option is, to filter the ADSI statement by something like <em>‘get all user starting with a to j’</em>, when you are sure, that in this case less than 900 records will be given back and repeat the statement several times and glue the data together via a <code>UNION</code> statement:</p>
<pre>
<code>SELECT  
    UserPrincipalName,  
    DisplayName,  
    sAMAccountName AS [SamAccountName],  
    sn AS [LastName],  
    givenName AS [FirstName],  
    title AS [Title],  
    Mail as [MailAddress],
    department AS [Department],  
    l AS [Location],  
    postalCode AS [PostCode],  
    streetAddress AS [Street],
    st AS [State]  
FROM (  
    SELECT *
    FROM OpenQuery(ADSI, '
        SELECT  
            UserPrincipalName,  
            DisplayName,  
            sAMAccountName,  
            sn,  
            givenName,  
            department,  
            title,  
            Mail,  
            l,  
            postalCode,
            streetAddress,  
            st  
        FROM ''LDAP://gag.de/DC=gag,DC=de''  
        WHERE objectClass =  ''User''  
        AND objectCategory = ''Person''  
        AND sn=''*''  
        AND givenName = ''*''  
        <strong>AND sAMAccountName <= ''j''< strong>
    ')

    <strong>UNION ALL</strong>

    SELECT *  
    FROM OpenQuery(ADSI, '  
        SELECT <em><...same as above></...same></em>  
        FROM ''LDAP://gag.de/DC=gag,DC=de''  
        WHERE objectClass =  ''User''  
        AND objectCategory = ''Person''  
        AND sn=''*''  
        AND givenName = ''*''  
        <strong>AND sAMAccountName > ''j'' AND sAMAccountName < ''p''</strong>  
    ')

    <strong>UNION ALL</strong>

    SELECT *
    FROM OpenQuery(ADSI,  '
        SELECT <em><...same as above></...same></em>
        FROM ''LDAP://gag.de/DC=gag,DC=de''
        WHERE objectClass =  ''User''
        AND objectCategory = ''Person''
        AND sn=''*'' AND givenName = ''*''
        <strong>AND sAMAccountName >= ''p''</strong>
    ')
) AD</=></strong></code>
</pre>

<p>When you store this as a VIEW, you can join it wherever you want on SQL Server:</p>
<pre>
<code>CREATE VIEW [dbo].[vADUsers]
AS
    <em><...sql code from above></...sql></em>

GO</code>
</pre>

<h3 id="SQL-Server-Database-Project"><a href="#SQL-Server-Database-Project" class="headerlink" title="SQL Server Database Project"></a>SQL Server Database Project</h3><p>If you work with a SQL Server Database Project, to have the complete structure of your database available in a version control system, you will get some reference errors on compiling and publishing your newly added SQL-View <code>vADUsers</code> and some objects which rely on the View, because of following problems:</p>
<ol>
<li>Project doesn’t know the Linked Server <code>ADSI</code></li>
<li>The structure (fields) of the data source is unknown</li>
</ol>
<h4 id="Declare-the-Linked-Server"><a href="#Declare-the-Linked-Server" class="headerlink" title="Declare the Linked Server"></a>Declare the Linked Server</h4><p>To show the Project that there is a Linked Server called <code>ADSI</code>, just add following lines at the start of your view:</p>
<pre>
<code><strong>sp_addlinkedserver 'ADSI'</strong>
<strong>GO</strong>

CREATE VIEW [dbo].[vADUsers]
AS
    <em><...sql code from above></...sql></em></code>
</pre>

<p>This mimics the adding of a Linked Server, but will be ignored by SQL Server on publish, because you already have a Linked Server with this name. The project is happy with it.</p>
<h4 id="Declare-the-data-structure"><a href="#Declare-the-data-structure" class="headerlink" title="Declare the data structure"></a>Declare the data structure</h4><p>When you use the SQL-View <code>vADUsers</code> in a Stored Procedure for example, this object won’t compile, because the project knows nothing about the fields of the ADSI data source. The SELECT in the view is not enough. You have to add an empty <code>SELECT</code> to the View <code>vADUsers</code>, just for the declaration of the fields and without returning any records and join this via <code>UNION</code> with the other statements:</p>
<pre>
<code>sp_addlinkedserver 'ADSI'
GO

CREATE VIEW [dbo].[vtADAllUsers]
AS

SELECT
    UserPrincipalName,
    DisplayName,
    sAMAccountName AS [SamAccountName],
    sn AS [LastName],
    givenName AS [FirstName],
    title AS [Title],
    Mail as [MailAddress],
    department AS [Department],
    l AS [Location],
    postalCode AS [PostCode],
    streetAddress AS [Street],
    st AS [State]
FROM (

    -- Fake SELECT to declare the structure of the view<strong>
    SELECT TOP 0
        '' UserPrincipalName,
        '' DisplayName,
        '' sAMAccountName,
        '' sn,
        '' givenName,
        '' department,
        '' title,
        '' Mail,
        '' l,
        '' postalCode,
        '' streetAddress,
        '' st

    UNION ALL</strong>

    SELECT *
    FROM OpenQuery(ADSI, '
        SELECT
            UserPrincipalName,
            DisplayName,
            sAMAccountName,
            sn,
            givenName,
            department,
            title,
            Mail,
            l,
            postalCode,
            streetAddress,
            st
        FROM ''LDAP://mydomain.de/DC=mydomain,DC=de''
        WHERE objectClass =  ''User''
        AND objectCategory = ''Person''
        AND sn=''*''
        AND givenName = ''*''
        AND sAMAccountName <= ''j'' ') union all select * from openquery(adsi, ' <em><...same as above>
        FROM ''LDAP://mydomain.de/DC=mydomain,DC=de''
        WHERE objectClass =  ''User''
        AND objectCategory = ''Person''
        AND sn=''*''  
        AND givenName = ''*''
        AND sAMAccountName > ''j''
        AND sAMAccountName < ''p''
    ')

    UNION ALL

    SELECT *
    FROM OpenQuery(ADSI,  '
        SELECT <em><...same as above></...same></em>
        FROM ''LDAP://mydomain.de/DC=mydomain,DC=de''
        WHERE objectClass =  ''User''
        AND objectCategory = ''Person''
        AND sn=''*''
        AND givenName = ''*''
        AND sAMAccountName >= ''p''
    ')
) AD</...same></=></code>
</pre>

<p>Now, you can fetch data from Active Directory and store the code in a Database Project.</p>
<p>HAPPY CODING :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kristofzerbe.github.io/kiko.io/2019/09/17/How-To-Visual-Studio-Database-Project-and-ADSI/" data-id="ck0un6aqn0000ckl9bbtjdly6" class="article-share-link">Share</a>
      
        <a href="https://kristofzerbe.github.io/kiko.io/2019/09/17/How-To-Visual-Studio-Database-Project-and-ADSI/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ADSI/">ADSI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Database-Project/">Database Project</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Visual-Studio/">Visual Studio</a></li></ul>

    </footer>
  </div>
  
    
  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ADSI/">ADSI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database-Project/">Database Project</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio/">Visual Studio</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/09/17/How-To-Visual-Studio-Database-Project-and-ADSI/">How-To: Visual Studio Database Project and ADSI</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 <a href="https://github.com/kristofzerbe">Kristof Zerbe</a><br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/" target="_blank">GitHub</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com/kristofzerbe" class="mobile-nav-link">GitHub</a>
  
</nav>
    
<script>
  var disqus_shortname = 'kiko-io';
  
  var disqus_url = 'https://kristofzerbe.github.io/kiko.io/2019/09/17/How-To-Visual-Studio-Database-Project-and-ADSI/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>